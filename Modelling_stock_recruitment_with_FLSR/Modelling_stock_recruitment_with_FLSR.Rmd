---
title: Modelling stock-recruitment relationships with the FLSR class
author: Iago Mosqueira, EC JRC G03 and Laurie Kell, ICCAT
date: 04 September 2015
rights:  Creative Commons Share Alike 4.0
---


```{r pkgs}
library(FLCore)
```

We have the result of an stock assesment (using VPA) in ple4

```{r data}
data(ple4)
```

and now want to fit an stock-recruitment relationship

```{r}
rec(ple4)

ssb(ple4)
```

We can convert and FLStock into an FLSR

```{r}
p4sr <- as.FLSR(ple4)

summary(p4sr)
```

As recruitts are of age=1, the lag between ssb and rec is also 1

```{r}
rec(p4sr)

ssb(p4sr)
```

```{r}
plot(ssb(p4sr), rec(p4sr))
```

To fit a model, we need to select a functional form

```{r}
model(p4sr) <- ricker()
```

so p4sr is all set up

model formula
```{r}
model(p4sr)
```

log-likelihood function
```{r}
logl(p4sr)
```

initial values function
```{r}
initial(p4sr)
```

and ouputs: params
```{r}
params(p4sr)
```

Fitting thorugh MLE

```{r}
p4sr <- fmle(p4sr)
```

gives us some results, not too good

```{r}
summary(p4sr)
```

```{r}
plot(p4sr)
```

default method is Nelder-Mead

```{r}
p4sr <- fmle(p4sr, method='L-BFGS-B')
```


The nhser dataset is perfect for FLSR

```{r}
data(nsher)
```

```{r}
plot(ssb(nsher), rec(nsher))
```


There are also other SR models to choose from
```{r}
bevholt()

shepherd()

cushing()

geomean()

segreg()

rickerSV()

bevholtSV()

shepherdSV()

bevholtAR1()
```

Let's try ricker

```{r}
model(nsher) <- 'ricker'

nhri <- fmle(nsher)
```

and then bevholt

```{r}
model(nsher) <- 'bevholt'

nhbh <- fmle(nsher)
```

and compare the fits

```{r}
plot(nhri)

plot(nhbh)
```

... using AIC

```{r}
AIC(nhri)

AIC(nhbh)
```


or Schwarz's Bayesian Information Criterion

```{r}
BIC(nhri)

BIC(nhbh)

```

Predict recruitments using predict()

```{r}
predict(nhri, ssb=FLQuant(seq(185, 500, length=10)))
```


Profile the likelihood to check the fit

```{r}
profile(nhri)

profile(p4sr)
```


Fix some parameters, e.g. steepness

```{r}
model(p4sr) <- bevholtSV

p4sr <- fmle(p4sr, fixed = list(s = 0.8))
```

```{r}
plot(p4sr)
```

```{r}
params(p4sr)
```


Other outputs include the covariance matrix
```{r}
vcov(nhri)
```

from which we can derive a correlation matrix
```{r}
cov2cor(vcov(nhri)[,,1])
```


Bootstrapping

```{r}
niter <- 10

model(p4sr) <- bevholt

p4sr <- fmle(p4sr)

res.boot <- sample(c(residuals(p4sr)), niter * dims(p4sr)$year, replace=T)

p4sb <- propagate(p4sr, niter)

rec(p4sb) <- rec(p4sb) * exp(res.boot)

p4sb <- fmle(p4sb)

params(p4sb)
```

```{r}
plot(rec(p4sb))

plot(fitted(p4sb))

```
