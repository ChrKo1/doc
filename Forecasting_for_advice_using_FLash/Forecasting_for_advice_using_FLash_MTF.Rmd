---
title: "Forecasting for advice using FLash: Medium term forecasts"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  github_document
tags:
license: Creative Commons CC-BY SA
---
 
```{r, ini, echo=FALSE, results='hide', message=FALSE}
# This chunk set the document environment, so it is hidden
library(knitr)
opts_chunk$set(fig.align='center',
  message=FALSE, warning=FALSE, echo=TRUE, cache=TRUE)
options(width=50)
set.seed(1423)
```

This tutorial describes how Medium-Term Forecasts (MTF) can be performed using *FLR*.
It uses the *FLash* package for running projections as well as the *FLBRP* package for evaluating reference points.

MTFs use the same engine as Short-Term Forecasts (STFs). However, there are some key differences between them.
MTFs typically project over 5 to 10 years instead of the usual 3 years for a STF.
Because of this increase in projection length it is necessary to include a stock-recruitment relationship to simulate the dynamics of the biological stock (an STF uses a constant recruitment assumption).
MTFs may also have a more complicated projection control object because they can try to simulate management objectives (e.g. decreases in F over time).
Finally, MTFs may also include consideration of uncertainty by including stochasticity in the projections.

Special attention must be paid to the conditioning and future assumptions of the stock.

## Required packages

To follow this tutorial you should have installed the following packages:

- FLR: [FLCore](http://www.flr-project.org/FLCore/), [FLash](http://www.flr-project.org/FLash/), [FLBRP](http://www.flr-project.org/FLBRP/)

You can do so as follows,

```{r, eval=FALSE}
install.packages(c("FLCore"), repos="http://flr-project.org/R")
install.packages(c("FLash"), repos="http://flr-project.org/R")
install.packages(c("FLBRP"), repos="http://flr-project.org/R")
install.packages(c("FLAssess"), repos="http://flr-project.org/R")
```

```{r, pkgs}
# This chunk loads all necessary packages, trims pkg messages
library(FLCore)
library(FLash)
library(FLBRP)
library(FLAssess)
```

# Introduction to Medium Term Forecasts

Running a MTF is similar to running a STF in that we need several components:

1. An FLStock object set up for the future (assumptions);
2. A stock-recruiment relationship (SRR);
3. A projection control object;

However, there are some significant differences between an MTF and an STF:

1. An MTF is normally run for 5 to 10 years (an STF is normally 3 years);
2. An MTF can use different target types (e.g. setting catch targets, not just F targets);
3. A dynamic SRR should be used (the STF assumption of mean recruitment is not a good one for more a projection of more than 3 years);
4. We can include uncertainty in the recruitment and target values.

In this tutorial we will build a 10 year projection, introduce a range of target types (including minimum and maximum target values and relative target values), use a dynamic SRR and introduce uncertainty.

As ususal, we base the projections on plaice in the North Sea.

# Conditioning the projection

The first step is to condition the projection by making assumptions about the stock in the future and also to fit the SRR.

## Making the future stock

SOMETHING ON FWD WINDOW and STF

As ever, load the ple4 data:

```{r, ple4}
data(ple4)
```

We again use `stf()` to set up a future stock (see the STF tutorial.
This makes a lot of assumptions about the future stock (see the LINK TO STF tutorial for more details).
We may want to change some of these assumptions but for the moment we will use the defaults.

```{r, stf_condition}
# Set up a 10 year MTF
ple4_mtf <- stf(ple4, nyears = 10)
```
Now the stock goes up to 2018:

```{r, summarymtf}
summary(ple4_mtf)
```
MORE ON ASSUMPTIONS AND CONDITIONING

## The stock-recruitment relationship

In these examples we use a Beverton-Holt model (see the tutorial on fitting SRRs for more detail LINK TO SRR TUTORIAL).

```{r, fitSRR}
ple4_sr <- fmle(as.FLSR(ple4, model="bevholt"), control=list(trace=0))
plot(ple4_sr)
```

# Example 1: F targets

We saw in the STF tutorial how to set an F target (LINK).
Here is some quick revision.

We will set the future F at F status quo (again) and we assume that F status quo is the mean of the last 4 years

```{r, feg1}
f_status_quo <- mean(fbar(ple4)[,as.character(2005:2008)])
f_status_quo
```

Make the control *data.frame* including all the years of the projection:
```{r, feg2}
ctrl_target <- data.frame(year = 2009:2018,
			  quantity = "f",
			  val = f_status_quo)
```

Make the *fwdControl* object from the control *data.frame*:
```{r, feg3}
ctrl_f <- fwdControl(ctrl_target)
```

We can take a look at the control object.
We have columns of `year`, `quantity` (target type), `min`, `val` and `max`. `min` and `max` can be ignored for now.
There is also another table underneath (with `min`, `val` and `max`) - again, ignore this for now.

```{r, reg31}
ctrl_f
```

Run fwd() with our three ingredients
```{r, feg4}
ple4_f_sq <- fwd(ple4_mtf, ctrl = ctrl_f, sr = ple4_sr)
```

What just happened? We plot the stock from the year 2000.

```{r, fegplot}
plot(window(ple4_f_sq, start=2000))
```

The future Fs are as we set in the control object (good):

```{r, feg5}
fbar(ple4_f_sq)[,ac(2005:2018)]
```

What about recruitment? Remember we are now using a Beverton-Holt model.

```{r, feg6}
rec(ple4_f_sq)[,ac(2005:2018)]
```

The recruitment is not constant but is not changing very much. That's because the fitted model looks flat REF BACK TO THE SRR FIGURE.

# Example 2: A decreasing catch target

In this example we introduce two new things:

1. A new target type (catch);
2. A changing target value.

Setting a catch target allows to explore the consequences of different TAC strategies.
In this example, the TAC (the total catch of the stock) is reduced 10% each year for 10 years.

We create a vector of future catches based on the catch in 2008:

```{r, ceg1}
future_catch <- c(catch(ple4)[,"2008"]) * 0.9^(1:10)
future_catch
```

We create the *fwdControl* object, setting the quantity to `catch` and passing in the vector of future catches:

```{r, ceg2}
ctrl_catch <- fwdControl(
	data.frame(
		year=2009:2018,
		quantity = "catch",
		val=future_catch))
```

The control object has the desired catch target values.

```{r, ceg3}
ctrl_catch
```

We call `fwd()` with the stock, the control object and the SRR:

```{r, ceg4}
ple4_catch <- fwd(ple4_mtf, ctrl_catch, sr = ple4_sr)
```

And take a look at the results:

```{r, cegplot}
plot(window(ple4_catch, start=2000))
```

The decreasing catch targets have been hit. Note that F has to be similarly reduced to hit the catch targets, resulting in a surge in SSB.

# Example 3: Setting an SSB target

In the previous examples we have set target types based on the activity of the fleet (F and catch).
We can also set biological target types. This is useful when there are biological reference points, e.g. Bpa.
Here we set SSB as the target.

## Care with timing

When setting a biological abundance target we have to consider the timing of the target.
In an FLStock, abundances are at the beginning of the year (or at the very end of the previous year).
For example, if you look at the total stock abundances you get the stock at the beginning of each year, i.e. before any fishing has occurred.

Internally, *FLash* attempts to hit the desired target by finding the appropriate value of F.
However, the stock abundance at the start of the year is the result of fishing in the previous year, i.e SSB in year Y depends on F in Y-1.
This means that if you set an abundance based target, you are really finding the F in the previous year that will give you that target. 
Setting an SSB target in a year is the equivalent of setting an SSB target for the very `end` of that year (the same as setting a target for the very start of the next year).
The result is that you have to be careful with the years in the control object when setting a target based on the stock abundance.

This is best illustrated with a simple example of a one year projection.
If we want to hit an SSB target in 2009 (i.e. the SSB at the start of 2009 etc), we actually set it in the control object as being for 2008 as it is in 2008 that the F will be found that hits the SSB in 2009.
In this example we want the future SSB to be high (we could have used *FLBRP* to come up with a suitable value, e.g. Bmsy but here we just pick a value).

```{r, seg2}
future_ssb <- 300000
ctrl_ssb <- fwdControl(data.frame(year=2008, quantity = "ssb", val=future_ssb))
ctrl_ssb
ple4_ssb <- fwd(ple4_mtf, ctrl_ssb, sr = ple4_sr)
```

Remember, we have effectively set an SSB target for the very end of 2008 but we do not see this in the *FLStock* until the very beginning of 2009.
The result is that we can see that the SSB target has been hit, but not until 2009.

```{r, seg3}
ssb(ple4_ssb)[,ac(2005:2009)]
```

## A longer projection

Here we run a longer projection with a constant SSB target.
The future stock object, `ple4_mtf`, only goes up to 2018. This means that in the control object we can only set an SSB target up to 2017.
Setting an SSB target for 2018 would try to hit the SSB at the start of 2019 which is outside of our stock object, resulting in an error (try it, if you want).

```{r, seg4}
future_ssb <- 300000
ctrl_ssb <- fwdControl(data.frame(year=2008:2017, quantity = "ssb", val=future_ssb))
ple4_ssb <- fwd(ple4_mtf, ctrl_ssb, sr = ple4_sr)
```

The SSB has been hit upto 2018.

```{r, seg5}
ssb(ple4_ssb)[,ac(2005:2018)]
```

Note: we have to ignore the F and removals (catch, landings and discards) in 2018 as these have not been included in the projection and still hold their initial values.

```{r, seg6}
plot(window(ple4_ssb, start=2000, end=2017))
```

# Example 4:  Relative catch target

The examples above have dealt with ABSOLUTE target values.
We now introduce the idea of RELATIVE values.
This allows us to set the target value RELATIVE to the value in another year.

We do this by using the `rel.year` column in the control object (the year that the target is relative to).
The `val` column now holds the relative value, not the absolute value.

Here we set catches in the projection years to be 90% of the catches in the previous year, i.e. we want the catche in 2009 to be 0.9 * value in 2008 etc.

```{r, rceg1}
ctrl_rel_catch <- fwdControl(
	data.frame(year = 2009:2018,
		   quantity = "catch",
		   val = 0.9,
		   rel.year = 2008:2017))
```

When we look at the control object we can see that an extra column, `rel.year`, appears:

```{r, rceg2}
ctrl_rel_catch
```

We run the projection as normal:

```{r, rceg3}
ple4_rel_catch <- fwd(ple4_mtf, ctrl_rel_catch, sr = ple4_sr)
```

```{r, rceg4}
catch(ple4_rel_catch)
catch(ple4_rel_catch)[,ac(2009:2018)] / catch(ple4_rel_catch)[,ac(2008:2017)]
plot(window(ple4_rel_catch, start = 2001, end = 2018))
```

This is equivalent to the catch example above (LINK TO EXAMPLE 2) but without using absolute values.


# Alternative syntax for controlling the projection

SOMETHING ON CALLING FWD() AND SPECIFYING TARGETS AS ARGUMENTS

# References


# More information

* You can submit bug reports, questions or suggestions on this tutorial at <https://github.com/flr/doc/issues>.
* Or send a pull request to <https://github.com/flr/doc/>
* For more information on the FLR Project for Quantitative Fisheries Science in R, visit the FLR webpage, <http://flr-project.org>.

## Software Versions

* `r version$version.string`
* FLCore: `r packageVersion('FLCore')`
* FLash: `r packageVersion('FLash')`
* FLBRP: `r packageVersion('FLBRP')`
* FLAssess: `r packageVersion('FLAssess')`
* **Compiled**: `r date()`

## License

This document is licensed under the [Creative Commons Attribution-ShareAlike 4.0 International](https://creativecommons.org/licenses/by-sa/4.0) license.

## Author information

**Finlay Scott**. European Commission, DG Joint Research Centre, Directorate D - Sustainable Resources, Unit D.02 Water and Marine Resources, Ispra (VA), Italy. <https://ec.europa.eu/jrc/>
