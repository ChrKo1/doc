---
title: "A quick introduction to FLR"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
github_document:
  mathjax: TRUE
tags: [FLR]
license: Creative Commons Attribution-ShareAlike 4.0 International Public License
---
 
```{r, ini, echo=FALSE, results='hide', message=FALSE, warnings=FALSE, cache=FALSE}
library(knitr)
source("R/ini.R")
```

The Fisheries Library in R (FLR) is a collection of tools for quantitative fisheries science, developed in the R language, that facilitates the construction of bio-economic simulation models of fisheries systems as well as the application of a wide range of quantitative analysis.

FLR builds on the powerful R environment and syntax to create a [domain-specific language](https://en.wikipedia.org/wiki/Domain-specific_language) for the quantitative analysis of the expected risks and impacts of fisheries management decisions. The classes and methods in FLR consider uncertainty an integral part of our knowledge of fisheries systems.

## Required packages

To follow this tutorial you should have installed the following packages:

- CRAN: latticeExtra, gridExtra, ggplot2
- FLR: [FLCore](http://www.flr-project.org/FLCore/), [FLa4a](http://www.flr-project.org/FLa4a/), [ggplotFL](http://www.flr-project.org/ggplotFL/), [FLa4a](http://www.flr-project.org/FLa4a/)

You can do so as follows:

```{r, eval=FALSE}
install.packages(c("latticeExtra", "gridExtra", "ggplot2", "triangle", "copula", "coda", "mgcv"))
install.packages(c("FLCore", "ggplotFL", "FLa4a"), repos="http://flr-project.org/R")
```

# Classes and methods

The *FLCore* package defines a series of data structures that represent different elements of the fishery system. These structures are defined using R's S4 class system, while functions to operate on those classes are defined as methods. In this way function call (e.g. `plot()`) can be used on different classes and their behaviour is consistent with the class structure and content. For further information on the S4 class system, please look at the [introductory text on the **methods** package](https://stat.ethz.ch/R-manual/R-patched/library/methods/html/Introduction.html).

## FLQuant

The [FLQuant](http://www.flr-project.org/FLCore/reference/FLQuant.html) class is the basic data structure for **FLR**, and it is in essence a 6D array on which data and outputs can be stored, structured along dimensions related to time, space, age or length, etc. It is also able to keep track of the units of measurement employed, as a simple character vector, although various operations on these objects are aware of the units of measurements contained in them.

We will be creating an altering *FLQuant* objects as we go along, but we can long briefly at some basic operations, as the syntax will then be used in other classes in *FLR*.

Let's first load the necessary packages in our session. The **FLCore** paxckage

```{r, flcore}
library(FLCore)
library(ggplotFL)
```

As it is the case for R classes, for example *data.frame*, classes in *FLR* can be constructed using a constructor method with the same name as the class, in this case `FLQuant()`.

```{r, flquant}
FLQuant(1:10)
```

The *FLQuant* constructor can take a variety of inputs, like a vector, a matrix or an array, and also allows you to specify a nuber of arguments. We will only look now at three of them, `units` for the units of measurement, `quant` for the name of the first dimension, and `dimnames` for the dimension names of the object. For example, to construct an object holding (random) data in tonnes on catches for ages 1 to 4, over a period of 6 years, one could call

```{r, flquantage}
flq <- FLQuant(rlnorm(60), dimnames=list(age=1:4, year=2012:2017), units="t")

flq
```

The object has six dimensions, although some of them (`unit`, `season`, `area` and `iter`) ar not used in this case. We can inspect the object in various ways

```{r, flquantinspect}
# A summary of structure and data
summary(flq)

# dimnames
dimnames(flq)

# dims
dim(flq)

# units
units(flq)
```

It can be also subset and modified

```{r, flquantmodify}
# Extract first year
flq[, 1]

# Extract year 2013
flq[, "2013"]

# Set catches on age 1 to zero
flq[1,] <- 0
flq
```

as it can be used in many operations

```{r, flquantarith}
# Product with scalar
flq * 10

# Addition with another FLQuant
flq + (flq * 0.20)

# Sum along years
yearSums(flq)
```

### More information

To learn more about the class, check the [FLQuant help page](http://www.flr-project.org/FLCore/reference/FLQuant.html).

# Loading your data

The first step in an analysis is to get the relevant data into the system. We will need to construct objects of certain **FLR** classes, but first data is loaded into the R session using any of the tools available in the language: `read.csv` for CSV files, `readVPA` and others for fisheries legacy file formats, ...

In this example we will create an object of class *FLStock*, a representation of both inputs and outputs involved in fitting a stock assessment model, from a CSV file containing a table with five columns:

- *slot*, the name of the input quantity, in this case either landings at age, *landings.n*, weight-at-age in the landings, *landings.wt*, and the same quantitieds for discards, *discards.n* and *discards.wt*.
- *age* and *year*
- *data*, the numeric values themselves.
- *units*, a character string for the units of measurement employed: *kg* and *1000* in this case for kilograms and thousands.

The file is downloaded into a temporary folder, and uncompressed. Simply change the value of `dir` to save the file in another folder.

```{r, getfiles, message=FALSE}
dir <- tempdir()
download.file("http://www.flr-project.org/doc/src/ple4.csv.zip", file.path(dir, "ple4.csv.zip"))
unzip(file.path(dir, "ple4.csv.zip"), exdir=dir)
```

The CSV file can now be loaded as a `data.frame` using `read.csv` and inspected

```{r, loadple4}
dat <- read.csv(file.path(dir, "ple4.csv"))
head(dat)
```

This data.frame contains the time series of landings and discards at age, in thousands, and the corresponding mean weights-at-age, in kg, for [North Sea plaice](http://standardgraphs.ices.dk/ViewCharts.aspx?key=8980) (*Pleuronectes platessa*, ICES ple.27.420).

We can create an object to store the landings-at-age data by subsetting it from the *data.frame*

```{r, subsetlandingsn}
landn <- subset(dat, slot=="landings.n", select=-slot)
```

and then convert into an *FLQuant* using

```{r, convertlandingsn}
landsn <- as.FLQuant(landn)
```

The object can now be inspected and plotted using the FLR-defined methods

```{r, plotlandings.n}
summary(landsn)

plot(landsn)
```

In a similar way, we can now convert the input *data.frame*, containing data for four data elements, as specified in the `slots` column, into an *FLStock* object, `ple4`

```{r, convertple4}
ple4 <- as.FLStock(dat)

summary(ple4)
```

To complete this *FLStock* object we will need to specify the natural mortality, *m*, in this case as a constant value of 0.1 for all ages and years,

```{r, ple4m}
m(ple4) <- 0.1
```

the proportion of natural and fishing mortality that takes place before spawning, assumed to be zero in both cases,

```{r, ple4spwn}
m.spwn(ple4) <- harvest.spwn(ple4) <- 0
```

and the maturity at age, as the proportion mature, as a vector repeated for all years.

```{r, ple4mat}
mat(ple4) <- c(0, 0.5, 0.5, rep(1, 7))
```

We now must compute the overall landings and discards, in biomass, from the age-disaggregated values,

```{r, ple4compute}
landings(ple4) <- computeLandings(ple4)
discards(ple4) <- computeDiscards(ple4)
```

and then the catch slots from both landings and discards

```{r, ple4catch}
catch(ple4) <- computeCatch(ple4, slot="all")
```

The mean weigth-at-age in the stock needs to be provided. In this case we will assume it is the same as the one computed from the catch sampling programme

```{r, ple4stockwt}
stock.wt(ple4) <- catch.wt(ple4)
```

We finalize by specifying the fully selected age range, used in the calculation of an overall index of fishing mortality, for example as the mean, using  `fbar()`, or as the maximum value, using `fapex()` across those ages. This information is part of the object's *range*.

```{r, ple4range}
range(ple4, c("minfbar", "maxfbar")) <- c(2, 6)
```

If we now inspect the resulting object we can see that all calculated slots have been assigned the corresponding *units* of measurement, except for those that will hold the estimates coming from a stock assessment model: *stock*, *stock.n* and *stock.wt* for the estimates of abundance, and *harvest* for the estimates of fishing mortality at age.

```{r, ple4}
summary(ple4)

plot(metrics(ple4, Catch=catch, Landings=landings))
```

### More information

Please see the [Reading data into FLR](Reading_data_into_FLR.html) tutorial for more examples on how to get your data into into **FLR**.

# Visualizing and plotting

# Running a stock assessment

An important step in providing management advice for a fish stock is the estimation of current status, past history and stock productivity through an stock assessment (SA) model. The *FLStock* object we have created contains some of the inputs required for most SA models: catches, natural mortality, and maturity. What is now needed is some indication of changes in abundance over the period of exploitation, an index of abundance, derived from either research surveys or catch-per-unit-effort of commercial fleets.

## Index of abundance

An index of abundance for the North Sea plaice stock, as an object of class [FLIndex](http://www.flr-project.org/FLCore/reference/FLIndex.html), is available as an example dataset in *FLCore*, and can be loaded using the *data* command

```{r, loadple4index}
data(ple4.index)
```

This time series of abundances at age, covering from `r  dims(ple4.index)$minyear` to `r  dims(ple4.index)$maxyear`, was obtained during the [ICES International Bottom Trawl Survey](http://ocean.ices.dk/Project/IBTS/), as is one of the indices used by the Working Group on the Assessment of Demersal Stocks in the North Sea and Skagerrak (WGNSSK).

The *FLIndex* class is able to contain not only the index of abundance, in this case as an age-structured *FLQuant*, but also other information on variance, associated catches, effort, selectivity and catchability, which might be used by certain methods.

```{r, summaryple4index}
summary(ple4.index)

plot(ple4.index)
```

The *range* slot in this class contains information about the time period over which the survey takes place, as proportions of the year, in this case from the beginning of August to the end of September.

```{r, ple4indexrange}
range(ple4.index)[c("startf", "endf")]
```

## a4a statistical catch-at-age

The [FLa4a](http:flr-project.org/FLa4a) package provides an **FLR** implementation of the *a4a* model, an statistical catch-at-age model of medium complexity that has been designed to make use of the power and flexibility of R's formula-based model notation (as used for example in [lm](https://stat.ethz.ch/R-manual/R-patched/library/stats/html/lm.html)), while giving access to a solid and fast minimization algorithm implemented using [AD Model Builder](http://www.admb-project.org/).

```{r, fla4apkg}
library(FLa4a)
```

A first go at fitting this model to the *ple4* and *ple4.index* datasets requires a single line of code

```{r, sca}
fit <- sca(ple4, FLIndices(BTS=ple4.index))
```

This returns an object of class `r c(class(fit))` that contains the results fo the model fit, including the estimated catch-at-age, and the derived abundances and fishing mortality at age

```{r, summarya4afit}
summary(fit)
```

which we can use to update the *FLStock* object

```{r, ple4fit}
stk <- ple4 + fit
plot(stk)
```

Among other methods, *FLa4a* provides a range of tools for inspecting the quality of the model fit. For example, a set of residuals, for the fits to both the index olf abundance and 


### More information

Please see the [](.html) tutorial for more examples on how to .

# Exploring the stock-recruitment relationship

Fitting a model for the relationship between stock abundance and expected recruitment is necessary for forecasting the future dynamics of the stock under various levels of fishing mortality, the central element of fisheries management advice. Certain stock assessment models, for example most statistical catch-at-age models, include the stock-recruitment model in the estimated parameters, but for others, like Virtual Population Analysis, this is a setup carried out once the stock of population abundace have been obtained.

Both inputs and outputs for stock-recruitment models are stored in an object of the [FLSR](http://www.flr-project.org/FLCore/reference/FLSR.html) class which we can create directly from the SA results by coertion using

```{r, flsrcreate}
plsr <- as.FLSR(stk)
```

The resulting *FLSR* object contains the series of recruitment `rec`, the abundance of the first age, and the stock reproductive potential, in this case the spawning stock biomass `ssb`. Both series are already displaced as corresponds by the age of recruitment, 1 in this case.

```{r, flsrsummary}
summary(plsr)
```

We now need to choose a model to fit, and *FLCore* provides a number of them already defined in terms of:

- the model formula, kept in the `model` slot
- a function returning the log-likelihood, to be used for minimization, in the `logl` slot
- a function to obtain initial values for the minimization procedure, in the `initial` slot

See the [SR Models](http://www.flr-project.org/FLCore/reference/FLSR.html) help page for further details of the available models.

We can now assign the output of the chosen model function, in this case `ricker()` to the existing object using

```{r, flsrmodel}
model(plsr) <- ricker()
```

The model object is ready to fit, through Maximum Likelihood Estimation (MLE), using the `fmle` method defined in *FLCore*. This makes use of R's `optim`, but defaults to the Melder-Mead algorithm.

```{r, flsrfit, results="hide"}
plsr <- fmle(plsr)
```

Another look at the object ill show us that a number of slots now contain the results of the model fit, among them:

- `fitted` for the estimated recruitment, as an *FLQuant*
- `residuals` for the residuals in log space, *FLQuant*
- `params` for the estimated parameters, as an object of class *FLPar*
- `vcov` for the variance-covariance matrix, as an *array*

The standard plot for the class shows the model fit and a series of useful diagnostics that will help us evaluating the its quality and usefulness for future projections. This can be further explored by likelihood profiling over a range of values of the estimated parameters, simply calling the `profile` method of the object

```{r, flsrprofile}
profile(plsr)
```

Finally, the model can be used to predict future recruitments if provided with a set of new of values of SSB, as in

```{r, flsrpredict}
predict(plsr, ssb=FLQuant(rnorm(10, 25e4, sd(ssb(plsr))), dimnames=list(age=1, year=2008:2017)))
```

### More information

Please see the [Modelling stock recruitment with FLSR](Modelling_stock_recruitment_with_FLSR.html) tutorial for more examples and information on the stock-recruitment model fitting capabilities of **FLR**.

# Estimating reference points

### More information

Please see the [](.html) tutorial for more examples on how to .

# Forecasting under different scenarios

### More information

Please see the [](.html) tutorial for more examples on how to .

# Management Strategy Evaluation

# References

L. T. Kell, I. Mosqueira, P. Grosjean, J-M. Fromentin, D. Garcia, R. Hillary, E. Jardim, S. Mardle, M. A. Pastoors, J. J. Poos, F. Scott, R. D. Scott; FLR: an open-source framework for the evaluation and development of management strategies. *ICES J Mar Sci* 2007; 64 (4): 640-646. doi: [10.1093/icesjms/fsm012](https://doi.org/10.1093/icesjms/fsm012).

# More information

* You can submit bug reports, questions or suggestions on this tutorial at <https://github.com/flr/doc/issues>.
* Alternatively, send a pull request to <https://github.com/flr/doc/>.
* For more information on the FLR Project for Quantitative Fisheries Science in R, visit the FLR webpage: <http://flr-project.org>.

## Software Versions

* `r version$version.string`
* FLCore: `r packageVersion('FLCore')`
* **Compiled**: `r date()`

## License

This document is licensed under the [Creative Commons Attribution-ShareAlike 4.0 International](https://creativecommons.org/licenses/by-sa/4.0) license.

## Author information

**Iago MOSQUEIRA**. European Commission, DG Joint Research Centre, Directorate D - Sustainable Resources, Unit D.02 Water and Marine Resources, Via E. Fermi 2749, 21027 Ispra VA, Italy. <https://ec.europa.eu/jrc/>.
