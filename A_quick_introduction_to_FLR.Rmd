---
title: "A quick introduction to FLR"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
github_document:
  mathjax: TRUE
tags: [FLR]
license: Creative Commons Attribution-ShareAlike 4.0 International Public License
---
 
```{r, ini, echo=FALSE, results='hide', message=FALSE, warnings=FALSE, cache=FALSE}
library(knitr)
source("R/ini.R")
```

The Fisheries Library in R (FLR) is a collection of tools for quantitative fisheries science, developed in the R language, that facilitates the construction of bio-economic simulation models of fisheries systems as well as the application of a wide range of quantitative analysis.

FLR builds on the powerful R environment and syntax to create a [domain-specific language](https://en.wikipedia.org/wiki/Domain-specific_language) for the quantitative analysis of the expected risks and impacts of fisheries management decisions. The classes and methods in FLR consider uncertainty an integral part of our knowledge of fisheries system. [...]

## Required packages

To follow this tutorial you should have installed the following packages:

- FLR: [FLCore](http://www.flr-project.org/FLCore/), [FLa4a](http://www.flr-project.org/FLa4a/), [ggplotFL](http://www.flr-project.org/ggplotFL/)

You can do so as follows:

```{r, eval=FALSE}
install.packages(c("FLCore"), repos="http://flr-project.org/R")
```

The *FLCore* package defines a 6D array as the basic data structure for **FLR**. This class, called *FLQuant*, is used to store most numeric inputs and output.

```{r, flcore}
library(FLCore)
library(ggplotFL)
```

# Loading your data

The first step in an analysis is to get the relevant data into the system. We will need to construct objects of certain **FLR** classes, but first data is loaded into the R session using any of the tools available in the language: `read.csv` for CSV files, `readVPA` and others for fisheries legacy file formats, ...

In this example we will create an object of class *FLStock*, a representation of both inputs and outputs involved in fitting a stock assessment model, from a CSV file containing a table with five columns:

- *slot*, the name of the input quantity, in this case either landings at age, *landings.n*, weight-at-age in the landings, *landings.wt*, and the same quantitieds for discards, *discards.n* and *discards.wt*.
- *age* and *year*
- *data*, the numeric values themselves.
- *units*, a character string for the units of measurement employed: *kg* and *1000* in this case for kilograms and thousands.

The file is downloaded into a temporary folder, and uncompressed. Simply change the value of `dir` to save the file in another folder.

```{r, getfiles, message=FALSE}
dir <- tempdir()
download.file("http://www.flr-project.org/doc/src/ple4.csv.zip", file.path(dir, "ple4.csv.zip"))
unzip(file.path(dir, "ple4.csv.zip"), exdir=dir)
```

The CSV file can now be loaded as a `data.frame` using `read.csv` and inspected

```{r, loadple4}
dat <- read.csv(file.path(dir, "ple4.csv"))
head(dat)
```

The `df` data.frame contains the time series of landings and discards at age, in thousands, and the corresponding mean weights-at-age, in kg, for [North Sea plaice](http://standardgraphs.ices.dk/ViewCharts.aspx?key=8980) (*Pleuronectes platessa*, ICES ple.27.420).

We can create an object to store the landings-at-age data by subsetting it from the *data.frame*

```{r, subsetlandingsn}
landn <- subset(dat, slot=="landings.n", select=-slot)
```

and then convert into an *FLQuant* using

```{r, convertlandingsn}
landsn <- as.FLQuant(landn)
```

The object can now be inspected and plotted using the FLR-defined methods

```{r, plotlandings.n}
summary(landsn)

plot(landsn)
```

In a similar way, we can now convert the input *data.frame*, containing data for four data elements, as specified in the `slots` column, into an *FLStock* object, `ple4`

```{r, convertple4}
ple4 <- as.FLStock(dat)

summary(ple4)
```

To complete this *FLStock* object we will need to specify the natural mortality, *m*, in this case as a constant value of 0.1 for all ages and years,

```{r, ple4m}
m(ple4) <- 0.1
```

the proportion of natural and fishing mortality that takes place before spawning, assumed to be zero in both cases,

```{r, ple4spwn}
m.spwn(ple4) <- harvest.spwn(ple4) <- 0
```

and the maturity at age, as the proportion mature, as a vector repeated for all years.

```{r, ple4mat}
mat(ple4) <- c(0, 0.5, 0.5, rep(1, 7))
```

We now must compute the overall landings and discards, in biomass, from the age-disaggregated values,

```{r, ple4compute}
landings(ple4) <- computeLandings(ple4)
discards(ple4) <- computeDiscards(ple4)
```

and then the catch slots from both landings and discards

```{r, ple4catch}
catch(ple4) <- computeCatch(ple4, slot="all")
```

We finalize by specifying the fully selected age range, used in the calculation of an overall index of fishing mortality, for example as the mean, using  `fbar()`, or as the maximum value, using `fapex()` across those ages. This information is part of the object's *range*.

```{r, ple4range}
range(ple4, c("minfbar", "maxfbar")) <- c(2, 6)
```

If we now inspect the resulting object we can see that all calculated slots have been assigned the corresponding *units* of measurement, except for those that will hold the estimates coming from a stock assessment model: *stock*, *stock.n* and *stock.wt* for the estimates of abundance, and *harvest* for the estimates of fishing mortality at age.

```{r, ple4}
summary(ple4)

plot(metrics(ple4, Catch=catch, Landings=landings))
```

## More information

Please see the [Reading data into FLR](Reading_data_into_FLR.html) tutorial for more examples on how to get your into into **FLR**.

# Visualizing and plotting

# Running a stock assessment

# Exploring the stock-recruitment relationship

# Estimating reference points

# Forecasting undr different scenarios

# References

L. T. Kell, I. Mosqueira, P. Grosjean, J-M. Fromentin, D. Garcia, R. Hillary, E. Jardim, S. Mardle, M. A. Pastoors, J. J. Poos, F. Scott, R. D. Scott; FLR: an open-source framework for the evaluation and development of management strategies. *ICES J Mar Sci* 2007; 64 (4): 640-646. doi: [10.1093/icesjms/fsm012](https://doi.org/10.1093/icesjms/fsm012).

# More information

* You can submit bug reports, questions or suggestions on this tutorial at <https://github.com/flr/doc/issues>.
* Alternatively, send a pull request to <https://github.com/flr/doc/>.
* For more information on the FLR Project for Quantitative Fisheries Science in R, visit the FLR webpage: <http://flr-project.org>.

## Software Versions

* `r version$version.string`
* FLCore: `r packageVersion('FLCore')`
* **Compiled**: `r date()`

## License

This document is licensed under the [Creative Commons Attribution-ShareAlike 4.0 International](https://creativecommons.org/licenses/by-sa/4.0) license.

## Author information

**Iago MOSQUEIRA**. European Commission, DG Joint Research Centre, Directorate D - Sustainable Resources, Unit D.02 Water and Marine Resources, Via E. Fermi 2749, 21027 Ispra VA, Italy. <https://ec.europa.eu/jrc/>.
