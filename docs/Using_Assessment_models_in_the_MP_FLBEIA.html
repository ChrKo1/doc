<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />


<meta name="author" content="Sonia Sanchez and FLBEIA team" />


<title>Using different Assessment models in the Management Procedure of FLBEIA</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/yeti.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-1.1/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-1.1/highlight.js"></script>
<link href="site_libs/font-awesome-4.5.0/css/font-awesome.min.css" rel="stylesheet" />

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs && document.readyState && document.readyState === "complete") {
   window.setTimeout(function() {
      hljs.initHighlighting();
   }, 0);
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 45px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 50px;
  margin-top: -50px;
}

.section h2 {
  padding-top: 50px;
  margin-top: -50px;
}
.section h3 {
  padding-top: 50px;
  margin-top: -50px;
}
.section h4 {
  padding-top: 50px;
  margin-top: -50px;
}
.section h5 {
  padding-top: 50px;
  margin-top: -50px;
}
.section h6 {
  padding-top: 50px;
  margin-top: -50px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->






<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html"></a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="http://flr-project.org">
    <span class="fa fa-home"></span>
     
    FLR
  </a>
</li>
<li>
  <a href="index.html">
    <span class="fa fa-info"></span>
     
    Home
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-play-circle-o"></span>
     
    Intro
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="A_quick_introduction_to_FLR.html">A quick introduction to FLR</a>
    </li>
    <li>
      <a href="An_overview_of_the_FLCore_classes.html">An overview of the FLCore classes</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-database"></span>
     
    Input
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="Loading_your_data_into_FLR.html">Loading your data into FLR</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-magic"></span>
     
    Modelling
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="Modelling_stock_recruitment_with_FLSR.html">Modelling stock recruitment with FLSR</a>
    </li>
    <li>
      <a href="Statistical_catch_at_age_models_in_FLa4a.html">Statistical catch at age models in FLa4a</a>
    </li>
    <li>
      <a href="Modelling_growth_and_its_uncertainty_in_FLa4a.html">Modelling growth and its uncertainty in FLa4a</a>
    </li>
    <li>
      <a href="Natural_mortality_modelling_in_FLa4a.html">Natural mortality modelling in FLa4a</a>
    </li>
    <li>
      <a href="Stock_assessment_using_eXtended_Survivors_Analysis_with_FLXSA.html">Stock assessment using eXtended Survivors Analysis with FLXSA</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-tachometer"></span>
     
    Advice
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="Running_Medium_Term_Forecasts_with_FLash.html">Running Medium Term Forecasts with FLash</a>
    </li>
    <li>
      <a href="Short_Term_Forecasting_for_advice_using_FLash.html">Short Term Forecasting for advice using FLash</a>
    </li>
    <li>
      <a href="Forecasting_on_the_Medium_Term_for_advice_using_FLasher.html">Forecasting on the Medium Term for advice using FLasher</a>
    </li>
    <li>
      <a href="Reference_points_for_fisheries_management_with_FLBRP.html">Reference points for fisheries management with FLBRP</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-cogs"></span>
     
    MSE
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">An introduction to MSE using FLR</li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-area-chart"></span>
     
    Plotting
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="ggplotFL_plotting_FLR_objects_with_ggplot2.html">ggplotFL, plotting FLR objects with ggplot2</a>
    </li>
    <li>
      <a href="Plotting_FLR_objects_using_lattice.html">Plotting FLR objects using lattice</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-puzzle-piece"></span>
     
    Internals
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="Units_of_measurement_in_FLR_objects.html">Units of measurement in FLR objects</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="http://github.com/flr/doc/issues">
    <span class="fa fa-question fa-lg"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Using different Assessment models in the Management Procedure of FLBEIA</h1>
<h4 class="author"><em>Sonia Sanchez and FLBEIA team</em></h4>

</div>


<p><img src="images/FLBEIA_logo.png" width="10%" style="display: block; margin: auto;" /></p>
<div id="aim" class="section level1">
<h1>Aim</h1>
<p><strong>FLBEIA</strong> <span class="citation">[@garcia2017]</span> provides a battery of tutorials for learning how to use this software. This is the thirth tutorial of <strong>FLBEIA</strong> and it is a practical guide about how to implement different assessment models within <strong>FLBEIA</strong>.</p>
<p>In this tutorial they are presented some examples on how to include different assessment models in the management procedure to generate the observed population.</p>
<p>The Management Procedure Model (MPM) is divided into 3 components: the observation, the assessment and the management advice. The observation component produces the required data to run the assessment. Then, the assessment component is applied to those data to obtain the observed populations. Finally, the management advice component produces a management advice based on the observed populations. MPM procedure is applied yearly in the appropriate season of the year. Not necessarily in the last season, for example, it can be simulated as in the case of anchovy in the Bay of Biscay, where management is applied from the mid-season of one year to the mid-season of the next year. Simulations with multi-annual advice is also possible.</p>
<p>The exact way to define the objects used to set the simulation is described in the <strong>FLBEIA</strong> manual. This manual can be downloaded from <a href="https://github.com/flr/FLBEIA/blob/master/inst/doc/FLBEIA_manual.pdf">GitHub</a>, within the ‘doc’ folder of the package installation or typing <code>help(package = FLBEIA)</code> in the R console. Nevertheless, the objects to set the simulation doesn’t need to be defined for the following examples, as the dataset <code>one</code> from the FLBEIA package will be used. For details on these objects, see tutorial on FLBEIA - Simple example. <!-- [FLBEIA tutorial 2]+++LINK+++. --></p>
<p>To see all the datasets available in the <strong>FLBEIA</strong> package:</p>
<pre class="r"><code>data(package=&#39;FLBEIA&#39;)</code></pre>
</div>
<div id="required-packages-to-run-this-tutorial" class="section level1">
<h1>Required packages to run this tutorial</h1>
<p>To follow this tutorial you should have installed the following packages:</p>
<ul>
<li>CRAN: <a href="https://cran.r-project.org/web/packages/ggplot2/index.html">ggplot2</a></li>
<li>FLR: <a href="http://www.flr-project.org/FLCore/">FLCore</a>, <a href="http://www.flr-project.org/FLAssess/">FLAssess</a>, <a href="http://www.flr-project.org/FLash/">FLash</a>, <a href="http://www.flr-project.org/FLBEIA/">FLBEIA</a>, <a href="http://www.flr-project.org/FLFleet/">FLFleet</a>, <a href="http://www.flr-project.org/ggplotFL/">ggplotFL</a></li>
</ul>
<p>If you are using Windows, please use 32-bit R version because some of the packages do not work in 64-bit.</p>
<pre class="r"><code>install.packages( c(&quot;ggplot2&quot;))
install.packages( c(&quot;FLCore&quot;, &quot;FLBEIA&quot;, &quot;FLFleets&quot;, &quot;FLash&quot;, 
                    &quot;FLAssess&quot;, &quot;FLXSA&quot;, &quot;FLa4a&quot;, &quot;ggplotFL&quot;), 
                  repos=&quot;http://flr-project.org/R&quot;)
# Package for running SPiCT (only development version --&gt; needed package &quot;devtools&quot;&quot;)
install.packages(&quot;devtools&quot;)
library(devtools)
install_github(&quot;mawp/spict/spict&quot;)</code></pre>
<p>Load all necessary packages.</p>
<pre class="r"><code># Load all necessary packages.
library(FLBEIA)
library(FLAssess)
library(FLash)
library(ggplotFL)</code></pre>
</div>
<div id="observation-models" class="section level1">
<h1>Observation models</h1>
<p>The following alternatives are possible in the observation model, depending on the inclusion or not of the assessement in the MP.</p>
<ul>
<li>Stock without assessment:
<ul>
<li>The stock is not observed (<code>NoObsStock</code>), for example in the cases when
<ul>
<li>there is no need to observe the stock as it is managed independently to its status (e.g. v?a fixed TAC),</li>
<li>or when you use an alternative to know the abundance, through the observation of an abundance index, in biomass (<code>bioInd</code>) or age structured (<code>ageInd</code>), for example when using a HCR that requires an index to set the TAC.</li>
</ul></li>
<li>The population and the fleet are observed without errors (<code>perfectObs</code>), that could be usefull to test the HCR without any observation error;</li>
<li>It can be simulated an assessment, age structured (<code>age2agePop</code>) or aggregated in biomass (<code>age2bioPop</code> or `bio2bioPop```, respectively if stock is age structured or aggregated in biomass), given different types of errors defined a priori (e.g. ageing error, errors in the observation of numbers, weights or total biomass at age or errors in the observation of total landings or discards).</li>
</ul></li>
<li>Stock with assessment:
<ul>
<li>If biological information (e.g. natural mortality, mean weights, maturity,…) and/or catch information is required as input for the assessment, in biomass (<code>age2bioDat</code> or <code>bio2bioDat```, respectively if stock is age structured    or aggregated in biomass) or age structured (</code>age2ageDat`);</li>
<li>If the observation of an abundance index is required, in biomass (<code>bioInd</code>) or age structured (<code>ageInd</code>).</li>
</ul></li>
</ul>
<p>For more details on these functions and the related control objects see Sections 4.3.6-4.3.8 and Table C.5 in the <a href="https://github.com/flr/FLBEIA/blob/master/inst/doc/FLBEIA_manual.pdf"><strong>FLBEIA</strong> manual</a>.</p>
</div>
<div id="assessment-models" class="section level1">
<h1>Assessment models</h1>
<p>In this tutorial there will be presented several examples on the introduction of alternative assesments in the MP.</p>
<p>Alternative examples:</p>
<ol start="0" style="list-style-type: decimal">
<li><p>without assessment;</p></li>
<li><p>assessment which requires a biomass index, example with SPiCT assessment model;</p></li>
<li><p>assessment which requires an age structured index, example with SCA assessment model;</p></li>
<li><p>assessment which requires the observation of the population and the fleets and abundance indices, example with XSA assessment model.</p></li>
</ol>
</div>
<div id="example-0-no-assessment" class="section level1">
<h1>Example 0: no assessment</h1>
<div id="description" class="section level2">
<h2>Description</h2>
<p>This example represents a simulation without assessment in the Management Procedure (MP).</p>
<p>In this case, the Operating Model (OM) runs annually and it is formed by a single age-structured stock and an unique fleet which activity is performed in an unique metier. In the Management Procedure (MP), the fleet dynamics is assumed to be a Simple Mixed Fisheries behaviour (for details, see information on SMFB function in the <a href="https://github.com/flr/FLBEIA/blob/master/inst/doc/FLBEIA_manual.pdf"><strong>FLBEIA</strong> manual</a>, the stock is observed without error, there is not assessment carried out and the ICES HCR <span class="citation">[@ices2009]</span> is used to set the TAC yearly.</p>
<p>All the objects have 3 iterations and uncertainty in the projections comes exclusively from the generation of the new incoming recruitments.</p>
<ul>
<li>Operating model:
<ul>
<li>Biological:
<ul>
<li>Population dynamics: <code>stk1</code> - age structured population growth</li>
<li>SR model: <code>stk1</code> - Beverthon and Holt autoregressive/segmented regression</li>
</ul></li>
<li>Fleet: <code>fl1</code> - Simple Mixed Fisheries Behaviour</li>
<li>Covariates: covariates related to economy (e.g. number of vessels, fuel costs,…)</li>
</ul></li>
<li>Management Procedure:
<ul>
<li>Observation: <code>stk1</code> - perfect observation</li>
<li>Assessment: <code>stk1</code> - no assessment</li>
<li>Management advice: <code>stk1</code> - ICES harvest control rule</li>
</ul></li>
</ul>
<p>The neccesary <code>FLR</code> objects to run <strong>FLBEIA</strong> are available in the dataset called <code>one</code>.</p>
<pre class="r"><code>rm(list=ls()) # empty the workspace
data(one)     # load the dataset</code></pre>
</div>
<div id="exploring-the-data" class="section level2">
<h2>Exploring the data</h2>
<p>Information related to assessment component of the MP is provided in <code>oneAssC</code> object.</p>
<pre class="r"><code>oneAssC</code></pre>
<p>In this case, no abundance index is required, as there is no assessment and the HCR (<code>IcesHCR</code>) does not require any index, as it sets the TAC based on the perceived stock status.</p>
</div>
<div id="run-flbeia" class="section level2">
<h2>Run FLBEIA</h2>
<pre class="r"><code>s0 &lt;- FLBEIA( biols       = oneBio,   # FLBiols: FLBiol for stk1.
              SRs         = oneSR,    # List: FLSRSim for stk1.
              BDs         = NULL,     # Not population with biomass dynamics.
              fleets      = oneFl,    # FLFleets: one fleet.
              covars      = oneCv,    # List: covars related to economy.
              indices     = NULL,     # Not indices.
              advice      = oneAdv,   # List: &#39;TAC&#39; and &#39;quota.share&#39;
              main.ctrl   = oneMainC, # List: info on start and end of the simulation.
              biols.ctrl  = oneBioC,  # List: model to simulate the stock dynamics.
              fleets.ctrl = oneFlC,   # List: fleet dynamics models select. and other params.
              covars.ctrl = oneCvC,   # List: covariates dynamics (&quot;fixedCovar&quot;).
              obs.ctrl    = oneObsC,  # List: type of stock and index observation
                                      #       (&quot;PerfectObs&quot;).
              assess.ctrl = oneAssC,  # List: assessment model used (&quot;NoAssessment&quot;).
              advice.ctrl = oneAdvC)  # List: rule for TAC advice (&quot;IcesHCR&quot;).</code></pre>
</div>
<div id="results" class="section level2">
<h2>Results</h2>
<p>We show a comparison between the real population and the perceived one (i.e. assessment results).</p>
<pre class="r"><code>stk1.mp0 &lt;- s0$stocks[[&#39;stk1&#39;]]
stk1.om0 &lt;- FLBEIA:::perfectObs(s0$biols[[&#39;stk1&#39;]], s0$fleets, 
                                year = dim(s0$biols[[&#39;stk1&#39;]]@n)[2])
plot( FLStocks(real=stk1.om0, obs=stk1.mp0)) + theme(legend.position=&quot;top&quot;)</code></pre>
<p><img src="Using_Assessment_models_in_the_MP_FLBEIA_files/figure-html/unnamed-chunk-7-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>There are exactly the same, as expected, because there is not any observation error.</p>
</div>
</div>
<div id="example-1-spict-assessment" class="section level1">
<h1>Example 1: SPiCT assessment</h1>
<div id="description-1" class="section level2">
<h2>Description</h2>
<p>This example shows how to use SPiCT assessment <span class="citation">[@pedersen2016]</span> to obtain the observed populations in the Management Procedure (MP).</p>
<p>Currently there is an R package called <strong>spict</strong> that provides the framework to fit a surplus production model in R using fisheries catch and biomass index data, specifically the model is a Stochastic suplus Production model in Continuous-Time (SPiCT).</p>
<p><code>fit.spict</code> is the function to fit a contiunuous-time surplus production model to data using the TMB package. Following arguments are required:</p>
<ul>
<li><p>inp : List of input variables as output by check.inp</p></li>
<li><p>dbg : Debugging option. Will print out runtime information useful for debugging if set to 1. Will print even more if set to 2.</p></li>
</ul>
<p>For more details, type <code>?fit.spict</code> in the R console.</p>
<p>Within <strong>FLBEIA</strong> these arguments are given to the function through the assess.ctrl object, which is a named list with the names of the stocks and the following components for each stock:</p>
<ul>
<li><p>assess.model: character with the name of the assessment model or ‘NoAssessment’. To do the call to SPiCT, this argument has to be set to <code>spict2flbeia</code>, which is an FLBEIA function that links the inputs and outputs of <code>fit.spict</code> function with <strong>FLBEIA</strong> and calls to <code>fit.spict</code> function.</p></li>
<li><p>control: control object, which depends on the selected assessment model (e.g. FLXSA.control() for XSA assessment). +The FLXSA.control function creates a new control object required by XSA model. For more details see the FLR tutorial on Stock assessment using eXtended Survivors Analysis with FLXSA (<a href="http://www.flr-project.org/doc/Stock_assessment_using_eXtended_Survivors_Analysis_with_FLXSA.html">link</a>) . In this case, the default parameter values will be used.</p></li>
</ul>
<p>We load the SPiCT library:</p>
<pre class="r"><code>library(spict)</code></pre>
</div>
<div id="exploring-the-data-1" class="section level2">
<h2>Exploring the data</h2>
<p>In this example, the same dataset as in Example 0 will be used.</p>
<p>Information related to assessment component of the MP is provided in <code>oneAssC</code> object.</p>
<pre class="r"><code>oneAssC</code></pre>
<p>Now we need to set the control parameters for this assessment.</p>
<pre class="r"><code>oneAssC.spict &lt;- oneAssC
oneAssC.spict[[&quot;stk1&quot;]]$assess.model  &lt;- &quot;spict2flbeia&quot; # selected assessment model
oneAssC.spict[[&quot;stk1&quot;]]$harvest.units &lt;- &quot;f&quot;</code></pre>
<p>Additionally, we need and abundance index. We will take one age-structured <code>oneIndAge</code> object and its related control <code>oneObsCIndAge</code>. And inform in <code>advice.ctrl</code> what index should be used.</p>
<pre class="r"><code>summary(oneIndBio)</code></pre>
<table>
<thead>
<tr class="header">
<th></th>
<th align="left">Length</th>
<th align="left">Class</th>
<th align="left">Mode</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>stk1</td>
<td align="left">1</td>
<td align="left">FLIndices</td>
<td align="left">list</td>
</tr>
</tbody>
</table>
<pre class="r"><code>summary(oneObsCIndBio)</code></pre>
<table>
<thead>
<tr class="header">
<th></th>
<th align="left">Length</th>
<th align="left">Class</th>
<th align="left">Mode</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>stk1</td>
<td align="left">5</td>
<td align="left">-none-</td>
<td align="left">list</td>
</tr>
</tbody>
</table>
<pre class="r"><code># Check the observation controls related to the assessment and the observation of the index
oneObsCIndBio$stk1$stkObs$stkObs.model</code></pre>
<pre><code>[1] &quot;age2bioDat&quot;</code></pre>
<pre class="r"><code>oneObsCIndBio$stk1$indObs</code></pre>
<pre><code>$idBio
$idBio$indObs.model
[1] &quot;bioInd&quot;</code></pre>
</div>
<div id="run-flbeia-1" class="section level2">
<h2>Run FLBEIA</h2>
<pre class="r"><code>s1 &lt;- FLBEIA( biols       = oneBio,    # FLBiols: FLBiol for stk1.
              SRs         = oneSR,     # List: FLSRSim for stk1.
              BDs         = NULL,      # Not population with biomass dynamics.
              fleets      = oneFl,     # FLFleets: one fleet.
              covars      = oneCv,     # List: covars related to economy.
              indices     = oneIndBio, # Biomass index.
              advice      = oneAdv,    # List: &#39;TAC&#39; and &#39;quota.share&#39;
              main.ctrl   = oneMainC,  # List: info on start and end of the simulation.
              biols.ctrl  = oneBioC,   # List: model to simulate the stock dynamics.
              fleets.ctrl = oneFlC,    # List: fleet dynamics models select. and other params.
              covars.ctrl = oneCvC,    # List: covariates dynamics (&quot;fixedCovar&quot;).
              obs.ctrl    = oneObsCIndBio, # List: type of stock and index observation
                                           #       (&quot;age2bioDat&quot;,&quot;bioInd&quot;).
              assess.ctrl = oneAssC.spict, # List: assessment model used (&quot;spict2flbeia&quot;).
              advice.ctrl = oneAdvC)  # List: rule for TAC advice (&quot;IcesHCR&quot;).</code></pre>
</div>
<div id="results-1" class="section level2">
<h2>Results</h2>
<p>We show a comparison between the real population and the perceived one (i.e. assessment results).</p>
<pre class="r"><code>stk1.mp1 &lt;- s1$stocks[[&#39;stk1&#39;]]
stk1.om1 &lt;- FLBEIA:::perfectObs(s1$biols[[&#39;stk1&#39;]], s1$fleets, year = dim(s1$biols[[&#39;stk1&#39;]]@n)[2])
adf &lt;- as.data.frame
s1_pop &lt;- rbind( data.frame( population=&#39;obs&#39;, indicator=&#39;SSB&#39;, as.data.frame(ssb(stk1.mp1))), 
                 data.frame( population=&#39;obs&#39;, indicator=&#39;Harvest&#39;, as.data.frame(harvest(stk1.mp1))), 
                 data.frame( population=&#39;obs&#39;, indicator=&#39;Catch&#39;, as.data.frame(catch(stk1.mp1))), 
                 data.frame( population=&#39;real&#39;, indicator=&#39;SSB&#39;, as.data.frame(ssb(stk1.om1))), 
                 data.frame( population=&#39;real&#39;, indicator=&#39;Harvest&#39;, as.data.frame(fbar(stk1.om1))), 
                 data.frame( population=&#39;real&#39;, indicator=&#39;Catch&#39;, as.data.frame(catch(stk1.om1))))
p &lt;- ggplot( data=s1_pop, aes(x=year, y=data, color=population)) + 
  geom_line() +
  facet_grid(indicator ~ ., scales=&quot;free&quot;) + 
  geom_vline(xintercept = oneMainC$sim.years[[&#39;initial&#39;]]-1, linetype = &quot;longdash&quot;)+
  theme_bw()+
  theme(text=element_text(size=15),
        title=element_text(size=15,face=&quot;bold&quot;),
        strip.text=element_text(size=15), 
        legend.position=&quot;top&quot;)+
  ylab(&quot;&quot;)
print(p)</code></pre>
<p><img src="Using_Assessment_models_in_the_MP_FLBEIA_files/figure-html/unnamed-chunk-13-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="example-2-statistical-catch-at-age-assessment" class="section level1">
<h1>Example 2: Statistical Catch-at-Age assessment</h1>
<div id="description-2" class="section level2">
<h2>Description</h2>
<p>This example shows how to carry out an assessment using an Statistical Catch-at-Age method <span class="citation">[@millar2015]</span> to obtain the observed populations in the Management Procedure (MP).</p>
<p>Currently there is an R package called <strong>FLa4a</strong> that provides a simple and robust statistical Catch at Age model that is specifically designed for stocks with intermediate levels of data quantity and quality. ???sca??? is the User interface to the statistical catch-at-age method of the a4a stock assessment framework. Following arguments are required: * stock : An FLStock object to be used for the analysis * indices: An FLIndices object holding the indices of abundance to consider in the model * fmodel : A formula object depicting the model for log fishing mortality at age * qmodel : A list of formula objects depicting the models for log survey catchability at age * srmodel: A formula object depicting the model for log recruitment * fit : Character with type of fit: ‘MP’ or ‘assessment’; the former does not require the hessian to be computed, while the latter does.</p>
<p>For more details, type ``<code>?sca</code> in the R console.</p>
<p>Within <strong>FLBEIA</strong> these arguments are given to the function through the assess.ctrl object, which is a named list with the names of the stocks and the following components for each stock: * assess.model: character with the name of the assessment model or ‘NoAssessment’. To do the call to <code>sca```, this argument has to be set to</code>sca2flbeia<code>,     wich is an FLBEIA function that links the inputs and outputs of `sca` function     with **FLBEIA** and calls to `sca` function. * control: control object, which depends on the selected assessment model.     That is a list with the controls required for sca assessment, these are `fmod</code>, <code>qmod</code> and <code>srmod</code>.</p>
<p>We load the FLa4a library.</p>
<pre class="r"><code># library(FLa4a)</code></pre>
<p>The neccesary <code>FLR</code> objects to run <strong>FLBEIA</strong> are available in the dataset called <code>one</code>.</p>
<pre class="r"><code>rm(list=ls()) # empty the workspace
data(one)     # load the dataset</code></pre>
<p>However, in this dataset the assessment is set to <code>noAssessment</code> (that is, there is no assessment carried out in this case). So we need to change the initial settings in the loaded dataset to allow the call to SCA assessment model.</p>
</div>
<div id="exploring-the-data-2" class="section level2">
<h2>Exploring the data</h2>
<p>Information related to assessment component of the MP is provided in <code>oneAssC</code> object.</p>
<pre class="r"><code>oneAssC</code></pre>
<p>Now we need to set the control parameters for this assessment.</p>
<pre class="r"><code>oneAssC.sca &lt;- oneAssC
oneAssC.sca$stk1$assess.model &lt;- &quot;sca2flbeia&quot; # selected assessment model
oneAssC.sca[[&quot;stk1&quot;]]$harvest.units &lt;- &quot;f&quot;
oneAssC.sca[[&quot;stk1&quot;]]$control$test &lt;- TRUE    # control values</code></pre>
<p>Additionally, we need and abundance index. We will take one age-structured <code>oneIndAge</code> object and its related control <code>oneObsCIndAge</code>. And inform in <code>advice.ctrl</code> what index should be used.</p>
<pre class="r"><code>summary(oneIndAge)</code></pre>
<table>
<thead>
<tr class="header">
<th></th>
<th align="left">Length</th>
<th align="left">Class</th>
<th align="left">Mode</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>stk1</td>
<td align="left">1</td>
<td align="left">FLIndices</td>
<td align="left">list</td>
</tr>
</tbody>
</table>
<pre class="r"><code>summary(oneObsCIndAge)</code></pre>
<table>
<thead>
<tr class="header">
<th></th>
<th align="left">Length</th>
<th align="left">Class</th>
<th align="left">Mode</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>stk1</td>
<td align="left">10</td>
<td align="left">-none-</td>
<td align="left">list</td>
</tr>
</tbody>
</table>
<pre class="r"><code># Check the observation controls related to the assessment and the observation of the index
oneObsCIndAge$stk1$stkObs$stkObs.model</code></pre>
<pre><code>[1] &quot;age2ageDat&quot;</code></pre>
<pre class="r"><code>oneObsCIndAge$stk1$indObs</code></pre>
<pre><code>$idAge
$idAge$indObs.model
[1] &quot;ageInd&quot;</code></pre>
</div>
<div id="run-flbeia-2" class="section level2">
<h2>Run FLBEIA</h2>
<pre class="r"><code># s2 &lt;- FLBEIA( biols       = oneBio,    # FLBiols: FLBiol for stk1.
#               SRs         = oneSR,     # List: FLSRSim for stk1.
#               BDs         = NULL,        # Not population with biomass dynamics.
#               fleets      = oneFl,     # FLFleets: one fleet.
#               covars      = oneCv,     # List: covars related to economy.
#               indices     = oneIndAge, # Age-structured index.
#               advice      = oneAdv,    # List: &#39;TAC&#39; and &#39;quota.share&#39;
#               main.ctrl   = oneMainC,  # List: info on start and end of the simulation.
#               biols.ctrl  = oneBioC,   # List: model to simulate the stock dynamics.
#               fleets.ctrl = oneFlC,    # List: fleet dynamics models select. and other params.
#               covars.ctrl = oneCvC,    # List: covariates dynamics (&quot;fixedCovar&quot;).
#               obs.ctrl    = oneObsCIndAge, # List: type of stock and index observation
#                                            #       (&quot;age2ageDat&quot;,&quot;ageInd&quot;).
#               assess.ctrl = oneAssC.sca,   # List: assessment model used (&quot;sca2flbeia&quot;).
#               advice.ctrl = oneAdvC)  # List: rule for TAC advice (&quot;IcesHCR&quot;).</code></pre>
</div>
<div id="results-2" class="section level2">
<h2>Results</h2>
<p>We show a comparison between the real population and the perceived one (i.e. assessment results).</p>
<pre class="r"><code># stk1.mp2 &lt;- s2$stocks[[&#39;stk1&#39;]]
# stk1.om2 &lt;- FLBEIA:::perfectObs(s2$biols[[&#39;stk1&#39;]], s2$fleets, year = dim(s2$biols[[&#39;stk1&#39;]]@n)[2])
# adf &lt;- as.data.frame
# s2_pop &lt;- rbind( data.frame( population=&#39;obs&#39;, indicator=&#39;SSB&#39;, as.data.frame(ssb(stk1.mp2))), 
#                  data.frame( population=&#39;obs&#39;, indicator=&#39;Harvest&#39;, as.data.frame(harvest(stk1.mp2))), 
#                  data.frame( population=&#39;obs&#39;, indicator=&#39;Catch&#39;, as.data.frame(catch(stk1.mp2))), 
#                  data.frame( population=&#39;real&#39;, indicator=&#39;SSB&#39;, as.data.frame(ssb(stk1.om2))), 
#                  data.frame( population=&#39;real&#39;, indicator=&#39;Harvest&#39;, as.data.frame(fbar(stk1.om2))), 
#                  data.frame( population=&#39;real&#39;, indicator=&#39;Catch&#39;, as.data.frame(catch(stk1.om2))))
# p &lt;- ggplot( data=s2_pop, aes(x=year, y=data, color=population)) + 
#   geom_line() +
#   facet_grid(indicator ~ ., scales=&quot;free&quot;) + 
#   geom_vline(xintercept = oneMainC$sim.years[[&#39;initial&#39;]]-1, linetype = &quot;longdash&quot;)+
#   theme_bw()+
#   theme(text=element_text(size=15),
#         title=element_text(size=15,face=&quot;bold&quot;),
#         strip.text=element_text(size=15),
#         legend.position=&quot;top&quot;)+
#   ylab(&quot;&quot;)
# print(p)</code></pre>
</div>
</div>
<div id="example-3-xsa-assessment" class="section level1">
<h1>Example 3: XSA assessment</h1>
<div id="description-3" class="section level2">
<h2>Description</h2>
<p>This example shows how to use XSA assessment <span class="citation">[@darby1994,@shepherd1997,@shepherd1999]</span> to obtain the observed populations in the Management Procedure (MP).</p>
<p>Currently there is an R package called <strong>FLXSA</strong> that provides the framework to perform eXtended Survivor Analysis in FLR. ???FLXSA??? is the function to run an XSA analysis and creates an FLXSA object used to analyse its results. Following arguments are required: * stock : An FLStock object to be used for the analysis * indices: An FLIndices object holding the indices of abundance to consider in the model * control: An FLXSA.control object giving parameters of the model (see FLXSA.control) * desc : A short description of this analysis For more details, type <code>?FLXSA</code> in the R console.</p>
<p>Within <strong>FLBEIA</strong> these arguments are given to the function through the assess.ctrl object, which is a named list with the names of the stocks and the following components for each stock: * assess.model: character with the name of the assessment model or ‘NoAssessment’. To do the call to <code>FLXSA</code>, this argument has to be set to <code>FLXSA2flbeia</code>, wich is an FLBEIA function that links the inputs and outputs of <code>FLXSA</code> function with <strong>FLBEIA</strong> and calls to <code>FLXSA</code> function. * control: control object, which depends on the selected assessment model. That is FLXSA.control() for XSA assessment. The FLXSA.control function creates a new control object required by XSA model. For more details see the FLR tutorial on Stock assessment using eXtended Survivors Analysis with FLXSA (<a href="http://www.flr-project.org/doc/Stock_assessment_using_eXtended_Survivors_Analysis_with_FLXSA.html">link</a>) . In this case, the default parameter values will be used.</p>
<p>We load the FLXSA library.</p>
<pre class="r"><code>library(FLXSA)</code></pre>
<p>The neccesary <code>FLR</code> objects to run this example are available in the dataset called <code>one</code>.</p>
<pre class="r"><code>rm(list=ls()) # empty the workspace
data(one)     # load the dataset</code></pre>
<p>However, in this dataset the assessment is set to <code>noAssessment</code> (that is, there is no assessment carried out). So we need to change the initial settings in the loaded dataset to allow the call to XSA assessment model.</p>
</div>
<div id="exploring-the-data-3" class="section level2">
<h2>Exploring the data</h2>
<p>In this example, the same dataset as in Example 1 will be used, but as mentioned before some parameters related to the selected assessment (i.e. XSA) need to be set.</p>
<p>Information related to assessment component of the MP is provided in <code>oneAssC</code> object.</p>
<pre class="r"><code>oneAssC</code></pre>
<p>Then we set the control parameters for XSA assessment:</p>
<pre class="r"><code>oneAssC1 &lt;- list()
oneAssC1$stk1 &lt;- list()
oneAssC1$stk1$assess.model &lt;- &#39;FLXSA2flbeia&#39;  # selected assessment model
oneAssC1$stk1$control      &lt;- FLXSA.control() # default control values
oneAssC1$stk1$work_w_Iter  &lt;- TRUE
oneAssC1$stk1$harvest.units &lt;- &#39;f&#39;</code></pre>
<p>Additionally, we need an abundance index. We will take one age-structured index available at <code>oneIndAge</code> object and its related control object <code>oneObsCIndAge</code>. And inform in <code>advice.ctrl</code> which index should be used.</p>
<pre class="r"><code>summary(oneIndAge)</code></pre>
<table>
<thead>
<tr class="header">
<th></th>
<th align="left">Length</th>
<th align="left">Class</th>
<th align="left">Mode</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>stk1</td>
<td align="left">1</td>
<td align="left">FLIndices</td>
<td align="left">list</td>
</tr>
</tbody>
</table>
<pre class="r"><code>summary(oneObsCIndAge)</code></pre>
<table>
<thead>
<tr class="header">
<th></th>
<th align="left">Length</th>
<th align="left">Class</th>
<th align="left">Mode</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>stk1</td>
<td align="left">10</td>
<td align="left">-none-</td>
<td align="left">list</td>
</tr>
</tbody>
</table>
<pre class="r"><code># Check the observation controls related to the assessment and the observation of the index
oneObsCIndAge$stk1$stkObs$stkObs.model</code></pre>
<pre><code>[1] &quot;age2ageDat&quot;</code></pre>
<pre class="r"><code>oneObsCIndAge$stk1$indObs</code></pre>
<pre><code>$idAge
$idAge$indObs.model
[1] &quot;ageInd&quot;</code></pre>
</div>
<div id="run-flbeia-3" class="section level2">
<h2>Run FLBEIA</h2>
<pre class="r"><code>s3 &lt;- FLBEIA( biols       = oneBio,    # FLBiols: FLBiol for stk1.
              SRs         = oneSR,     # List: FLSRSim for stk1.
              BDs         = NULL,        # Not population with biomass dynamics.
              fleets      = oneFl,     # FLFleets: one fleet.
              covars      = oneCv,     # List: covars related to economy.
              indices     = oneIndAge, # Age-structured index.
              advice      = oneAdv,    # List: &#39;TAC&#39; and &#39;quota.share&#39;
              main.ctrl   = oneMainC,  # List: info on start and end of the simulation.
              biols.ctrl  = oneBioC,   # List: model to simulate the stock dynamics.
              fleets.ctrl = oneFlC,    # List: fleet dynamics models select. and other params.
              covars.ctrl = oneCvC,    # List: covariates dynamics (&quot;fixedCovar&quot;).
              obs.ctrl    = oneObsCIndAge, # List: type of stock and index observation
                                           #       (&quot;age2ageDat&quot;,&quot;ageInd&quot;).
              assess.ctrl = oneAssC1, # List: assessment model used (&quot;FLXSAnew&quot;).
              advice.ctrl = oneAdvC)  # List: rule for TAC advice (&quot;IcesHCR&quot;).</code></pre>
</div>
<div id="results-3" class="section level2">
<h2>Results</h2>
<p>We show a comparison between the real population and the perceived one (i.e. assessment results).</p>
<pre class="r"><code>stk1.mp3 &lt;- s3$stocks[[&#39;stk1&#39;]]
stk1.om3 &lt;- FLBEIA:::perfectObs(s3$biols[[&#39;stk1&#39;]], s3$fleets, year = dim(s3$biols[[&#39;stk1&#39;]]@n)[2])
plot( FLStocks(real=stk1.om3, obs=stk1.mp3)) + theme(legend.position=&quot;top&quot;)</code></pre>
<p><img src="Using_Assessment_models_in_the_MP_FLBEIA_files/figure-html/unnamed-chunk-27-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="more-information" class="section level1">
<h1>More information</h1>
<ul>
<li>You can submit bug reports, questions or suggestions on this tutorial at <a href="https://github.com/flr/doc/issues" class="uri">https://github.com/flr/doc/issues</a>.</li>
<li>Or send a pull request to <a href="https://github.com/flr/doc/" class="uri">https://github.com/flr/doc/</a></li>
<li>For more information on the FLR Project for Quantitative Fisheries Science in R, visit the FLR webpage, <a href="http://flr-project.org" class="uri">http://flr-project.org</a>.</li>
<li>You can submit bug reports, questions or suggestions specific to <strong>FLBEIA</strong> to <a href="mailto:flbeia@azti.es">flbeia@azti.es</a>.</li>
</ul>
<div id="software-versions" class="section level2">
<h2>Software Versions</h2>
<ul>
<li>R version 3.4.1 (2017-06-30)</li>
<li>FLCore: 2.6.5</li>
<li>FLBEIA: 1.15.1</li>
<li>FLFleet: 2.6.0</li>
<li>FLash: 2.5.8</li>
<li>FLAssess: 2.6.1</li>
<li>FLXSA: 2.5.20140808</li>
<li>ggplotFL: 2.6.2</li>
<li>ggplot2: 2.2.1</li>
<li><strong>Compiled</strong>: Mon Oct 2 11:13:30 2017</li>
</ul>
</div>
<div id="license" class="section level2">
<h2>License</h2>
<p>This document is licensed under the <a href="https://creativecommons.org/licenses/by-sa/4.0">Creative Commons Attribution-ShareAlike 4.0 International</a> license.</p>
</div>
<div id="author-information" class="section level2">
<h2>Author information</h2>
<p><strong>FLBEIA team</strong>. AZTI. Marine Reserach Unit. Txatxarramendi Ugartea z/g, 48395, Sukarrieta, Basque Country, Spain. <strong>Mail</strong> <a href="mailto:flbeia@azti.es">flbeia@azti.es</a></p>
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
