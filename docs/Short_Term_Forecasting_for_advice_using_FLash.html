<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title>Short Term Forecasting for advice using FLash</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-1.1/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-1.1/highlight.js"></script>
<link href="site_libs/font-awesome-4.5.0/css/font-awesome.min.css" rel="stylesheet" />

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs && document.readyState && document.readyState === "complete") {
   window.setTimeout(function() {
      hljs.initHighlighting();
   }, 0);
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}

.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->






<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html"></a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="http://flr-project.org">
    <span class="fa fa-home"></span>
     
    FLR
  </a>
</li>
<li>
  <a href="index.html">
    <span class="fa fa-info"></span>
     
    Home
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-gear"></span>
     
    Introduction
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="A_quick_introduction_to_FLR.html">A quick intro</a>
    </li>
    <li>
      <a href="B.html">Page B</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-gear"></span>
     
    Input
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="A.html">Page A</a>
    </li>
    <li>
      <a href="B.html">Page B</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-gear"></span>
     
    Visualization
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="A.html">Page A</a>
    </li>
    <li>
      <a href="B.html">Page B</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-gear"></span>
     
    Modelling
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="A.html">Page A</a>
    </li>
    <li>
      <a href="B.html">Page B</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-gear"></span>
     
    Advice
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="A.html">Page A</a>
    </li>
    <li>
      <a href="B.html">Page B</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-gear"></span>
     
    MSE
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="A.html">Page A</a>
    </li>
    <li>
      <a href="B.html">Page B</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://example.com">
    <span class="fa fa-question fa-lg"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Short Term Forecasting for advice using FLash</h1>
<h4 class="date"><em>13 September, 2017</em></h4>

</div>


<p>Short term forecasts help projecting the stock to forecast the implications of different management choices over a limited number of years. There are three necessary ingredients when projecting in FLR:</p>
<ul>
<li>a stock object that you will forecast and about which you have made some assumptions regarding what will happen in the future,</li>
<li>a stock-recruitment relationship,</li>
<li>a projection control specifying what the targets are and when to hit them.</li>
</ul>
<p>In FLR, the method for short term forecasts is called <code>fwd()</code>, which takes an <code>FLStock</code>, <code>FLSR</code>, and <code>fwdControl</code>.</p>
<div id="required-packages" class="section level2">
<h2>Required packages</h2>
<p>To follow this tutorial you should have installed the following packages:</p>
<ul>
<li>CRAN: <a href="https://cran.r-project.org/web/packages/ggplot2/index.html">ggplot2</a></li>
<li>FLR: <a href="http://www.flr-project.org/FLCore/">FLCore</a>, <a href="http://www.flr-project.org/FLash/">FLash</a>, <a href="http://www.flr-project.org/FLAssess/">FLAssess</a>, <a href="http://www.flr-project.org/FLBRP/">FLBRP</a>, <a href="http://www.flr-project.org/ggplotFL/">ggplotFL</a></li>
</ul>
<p>if you are using Windows, please use the 32-bit R version</p>
<p>You can do so as follows,</p>
<pre class="r"><code>install.packages(c(&quot;FLAssess&quot;,&quot;FLBRP&quot;,&quot;ggplotFL&quot;), repos=&quot;http://flr-project.org/R&quot;)</code></pre>
<p>The example used here is for the ple4 data that is available in FLR. This needs to be loaded first.</p>
<pre class="r"><code># Load the required packages
library(FLAssess)
library(FLash)
library(ggplotFL)
library(FLBRP)
# Load the data
data(ple4)
summary(ple4)</code></pre>
<pre><code>An object of class &quot;FLStock&quot;

Name: Plaice in IV 
Description: Imported from a VPA file. ( N:\Projecten\ICES WG\Demersale werkgroep  [...] 
Quant: age 
Dims:  age  year    unit    season  area    iter
    10  52  1   1   1   1   

Range:  min max pgroup  minyear maxyear minfbar maxfbar 
    1   10  10  1957    2008    2   6   

catch         : [ 1 52 1 1 1 1 ], units =  t 
catch.n       : [ 10 52 1 1 1 1 ], units =  10^3 
catch.wt      : [ 10 52 1 1 1 1 ], units =  kg 
discards      : [ 1 52 1 1 1 1 ], units =  t 
discards.n    : [ 10 52 1 1 1 1 ], units =  10^3 
discards.wt   : [ 10 52 1 1 1 1 ], units =  kg 
landings      : [ 1 52 1 1 1 1 ], units =  t 
landings.n    : [ 10 52 1 1 1 1 ], units =  10^3 
landings.wt   : [ 10 52 1 1 1 1 ], units =  kg 
stock         : [ 1 52 1 1 1 1 ], units =  t 
stock.n       : [ 10 52 1 1 1 1 ], units =  10^3 
stock.wt      : [ 10 52 1 1 1 1 ], units =  kg 
m             : [ 10 52 1 1 1 1 ], units =  m 
mat           : [ 10 52 1 1 1 1 ], units =   
harvest       : [ 10 52 1 1 1 1 ], units =  f 
harvest.spwn  : [ 10 52 1 1 1 1 ], units =   
m.spwn        : [ 10 52 1 1 1 1 ], units =   </code></pre>
</div>
<div id="extending-the-stock-object-for-the-projections" class="section level1">
<h1>Extending the stock object for the projections</h1>
<p>Our ple4 stock goes up to 2008, and in this example we want to make a 3-year projection, so we need to extend the stock by 3 years (<code>nyears</code>).</p>
<p>The projection will predict abundances in the future, but what will the future stock weights, maturity, natural mortality, etc. be like? The assumptions about these will affect the outcome of the projection. Rather than using <code>window()</code> or <code>trim()</code> that make all future data <em>NA</em>, we use the <code>stf()</code> function (short term forecast) that has several options that allow one to control the assumptions about the future stock parameters.</p>
<p>These assumptions specify how many years you want to average over to set future values. For example, <code>wts.nyears</code> is the number of years over which to calculate the <code>*.wt</code>, <code>*.spwn</code>, <code>mat</code> and <code>m</code> slots. By default this is set to 3 years. This is a fairly standard assumption for short term forecasts, i.e. the future weights at age will be the same as the average of the last 3 years. This assumes that what is going to happen in the next few years will be similar to what happened in the last few years.</p>
<p>A simple 3-year forecast for the weights, natural mortality, etc., assuming these are equal to their averages over the last 3 years, is done by:</p>
<pre class="r"><code>maxyr_stk &lt;- range(ple4)[[&quot;maxyear&quot;]]
ple4_stf &lt;- stf(ple4,nyears=3,wts.nyears=3, na.rm=TRUE)
maxyr_stf &lt;- range(ple4_stf)[[&quot;maxyear&quot;]]</code></pre>
<p>Previously, the stock went up to 2008. Now the stock goes up to 2011 and the future weights are equal to the average of the last three observed years, as can be observed from the last six years of the stock weights of the ple4_stf object.</p>
<pre class="r"><code>range(ple4_stf)</code></pre>
<pre><code>      min       max plusgroup   minyear   maxyear   minfbar   maxfbar 
        1        10        10      1957      2011         2         6 </code></pre>
<pre class="r"><code>stock.wt(ple4_stf)[,ac((maxyr_stf-5):maxyr_stf)]</code></pre>
<pre><code>An object of class &quot;FLQuant&quot;
An object of class &quot;FLQuant&quot;
, , unit = unique, season = all, area = unique

    year
age  2006     2007     2008     2009     2010     2011    
  1  0.053000 0.048000 0.050000 0.050333 0.050333 0.050333
  2  0.129000 0.093000 0.114000 0.112000 0.112000 0.112000
  3  0.195000 0.239000 0.200000 0.211333 0.211333 0.211333
  4  0.321000 0.241000 0.278000 0.280000 0.280000 0.280000
  5  0.354000 0.337000 0.355000 0.348667 0.348667 0.348667
  6  0.424000 0.394000 0.429000 0.415667 0.415667 0.415667
  7  0.439000 0.458000 0.484000 0.460333 0.460333 0.460333
  8  0.506000 0.412000 0.627000 0.515000 0.515000 0.515000
  9  0.583000 0.526000 0.598000 0.569000 0.569000 0.569000
  10 0.730673 0.548489 0.730672 0.669945 0.669945 0.669945

units:  kg </code></pre>
<p>For maturity the same assumption (of the future being the same as the average of the last 3 years) holds, but those maturities were assumed constant already.</p>
<pre class="r"><code>mat(ple4_stf)[,ac((maxyr_stf-5):maxyr_stf)]</code></pre>
<pre><code>An object of class &quot;FLQuant&quot;
An object of class &quot;FLQuant&quot;
, , unit = unique, season = all, area = unique

    year
age  2006 2007 2008 2009 2010 2011
  1  0.0  0.0  0.0  0.0  0.0  0.0 
  2  0.5  0.5  0.5  0.5  0.5  0.5 
  3  0.5  0.5  0.5  0.5  0.5  0.5 
  4  1.0  1.0  1.0  1.0  1.0  1.0 
  5  1.0  1.0  1.0  1.0  1.0  1.0 
  6  1.0  1.0  1.0  1.0  1.0  1.0 
  7  1.0  1.0  1.0  1.0  1.0  1.0 
  8  1.0  1.0  1.0  1.0  1.0  1.0 
  9  1.0  1.0  1.0  1.0  1.0  1.0 
  10 1.0  1.0  1.0  1.0  1.0  1.0 

units:   </code></pre>
<p>Notice that the future fishing mortality has also been set (average of the last 3 years, by default).</p>
<pre class="r"><code>ggplot(harvest(ple4_stf)[,ac((maxyr_stf-5):maxyr_stf)]) + geom_line(aes(x=age, y=data)) + facet_wrap(~year)</code></pre>
<p><img src="Short_Term_Forecasting_for_advice_using_FLash_files/figure-html/figA-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>The stock numbers at age and the catch numbers at age are not forecast yet - this is what the <code>fwd()</code> function will perform later.</p>
<pre class="r"><code>stock.n(ple4_stf)[,ac((maxyr_stf-5):maxyr_stf)]</code></pre>
<pre><code>An object of class &quot;FLQuant&quot;
An object of class &quot;FLQuant&quot;
, , unit = unique, season = all, area = unique

    year
age  2006     2007     2008     2009     2010     2011    
  1  820006.3 949341.2 844041.2       NA       NA       NA
  2  554592.5 531914.3 784234.7       NA       NA       NA
  3  422068.8 269655.1 267892.4       NA       NA       NA
  4   88052.9 212889.2 142573.0       NA       NA       NA
  5  136368.1  45514.9 137660.4       NA       NA       NA
  6   17534.5  80086.2  25575.8       NA       NA       NA
  7   16289.7   9240.6  49356.8       NA       NA       NA
  8    4114.0   9297.5   5828.1       NA       NA       NA
  9    2688.5   1585.1   5078.7       NA       NA       NA
  10   2854.5   3660.1   6750.3       NA       NA       NA

units:  10^3 </code></pre>
<p>Meanwhile, the landings and discards are average forecast ratios (proportion of total catch) of what is discarded and what is landed over the last 3 years of data.</p>
<pre class="r"><code>discards.n(ple4_stf)[,ac((maxyr_stf-5):maxyr_stf)]</code></pre>
<pre><code>An object of class &quot;FLQuant&quot;
An object of class &quot;FLQuant&quot;
, , unit = unique, season = all, area = unique

    year
age  2006       2007       2008       2009       2010       2011      
  1  2.2047e+05 7.7312e+04 1.3541e+05 9.9308e-01 9.9308e-01 9.9308e-01
  2  2.2508e+05 2.0514e+05 2.5263e+05 9.3166e-01 9.3166e-01 9.3166e-01
  3  1.1022e+05 6.9312e+04 3.7393e+04 5.7876e-01 5.7876e-01 5.7876e-01
  4  1.0656e+04 1.0735e+04 6.2370e+03 2.0786e-01 2.0786e-01 2.0786e-01
  5  3.0000e+03 1.4370e+03 2.2820e+03 7.5111e-02 7.5111e-02 7.5111e-02
  6  4.1000e+02 7.1510e+03 5.1700e+02 1.4546e-01 1.4546e-01 1.4546e-01
  7  7.5400e+02 2.0400e+02 8.8820e+03 2.5884e-01 2.5884e-01 2.5884e-01
  8  1.9400e+02 1.6490e+03 8.9100e+02 3.5033e-01 3.5033e-01 3.5033e-01
  9  0.0000e+00 0.0000e+00 0.0000e+00 0.0000e+00 0.0000e+00 0.0000e+00
  10 0.0000e+00 0.0000e+00 0.0000e+00 0.0000e+00 0.0000e+00 0.0000e+00

units:  10^3 </code></pre>
<pre class="r"><code>landings.n(ple4_stf)[,ac((maxyr_stf-5):maxyr_stf)]</code></pre>
<pre><code>An object of class &quot;FLQuant&quot;
An object of class &quot;FLQuant&quot;
, , unit = unique, season = all, area = unique

    year
age  2006       2007       2008       2009       2010       2011      
  1  3.5500e+02 1.2860e+03 3.8000e+02 6.9226e-03 6.9226e-03 6.9226e-03
  2  1.8987e+04 1.9205e+04 1.0970e+04 6.8339e-02 6.8339e-02 6.8339e-02
  3  6.7465e+04 3.7309e+04 4.2865e+04 4.2124e-01 4.2124e-01 4.2124e-01
  4  2.5254e+04 4.7053e+04 3.7970e+04 7.9214e-01 7.9214e-01 7.9214e-01
  5  4.2525e+04 1.4971e+04 2.9476e+04 9.2489e-01 9.2489e-01 9.2489e-01
  6  6.5550e+03 1.7142e+04 5.7000e+03 8.5454e-01 8.5454e-01 8.5454e-01
  7  4.9670e+03 2.4590e+03 6.7520e+03 7.4116e-01 7.4116e-01 7.4116e-01
  8  2.0530e+03 1.8560e+03 9.1200e+02 6.4967e-01 6.4967e-01 6.4967e-01
  9  1.2350e+03 5.4300e+02 6.7300e+02 1.0000e+00 1.0000e+00 1.0000e+00
  10 1.3190e+03 1.2590e+03 8.9600e+02 1.0000e+00 1.0000e+00 1.0000e+00

units:  10^3 </code></pre>
<pre class="r"><code># Compare above landings.n for the forecast years with
yearMeans((landings.n(ple4)/(landings.n(ple4)+discards.n(ple4)))[,ac((maxyr_stk-2):maxyr_stk)])</code></pre>
<pre><code>An object of class &quot;FLQuant&quot;
An object of class &quot;FLQuant&quot;
, , unit = unique, season = all, area = unique

    year
age  1        
  1  0.0069226
  2  0.0683387
  3  0.4212371
  4  0.7921356
  5  0.9248890
  6  0.8545368
  7  0.7411596
  8  0.6496718
  9  1.0000000
  10 1.0000000

units:  NA </code></pre>
<pre class="r"><code># Furthermore, landings and discards proportions sum to 1
landings.n(ple4_stf)[,ac((maxyr_stf-2):maxyr_stf)] + discards.n(ple4_stf)[,ac((maxyr_stf-2):maxyr_stf)]</code></pre>
<pre><code>An object of class &quot;FLQuant&quot;
An object of class &quot;FLQuant&quot;
, , unit = unique, season = all, area = unique

    year
age  2009 2010 2011
  1  1    1    1   
  2  1    1    1   
  3  1    1    1   
  4  1    1    1   
  5  1    1    1   
  6  1    1    1   
  7  1    1    1   
  8  1    1    1   
  9  1    1    1   
  10 1    1    1   

units:  1000 </code></pre>
</div>
<div id="the-stock-recruitment-relationship-srr" class="section level1">
<h1>The stock-recruitment relationship (SRR)</h1>
<p>A short term forecast does not use an SRR (in the traditional sense). Instead, it generally assumes that recruitment in the future is some mean (e.g. geometric mean) of the historic recruitments. However, we still need to have an SRR that contains this mean value, which is what we mimic for this example. First, we estimate the geometic mean recruitment, that we then add to an SRR object</p>
<pre class="r"><code>mean_rec &lt;- exp(mean(log(rec(ple4))))
ple4_sr &lt;- as.FLSR(ple4, model=&quot;geomean&quot;)
params(ple4_sr)[&#39;a&#39;,] &lt;- mean_rec
params(ple4_sr)</code></pre>
<pre><code>An object of class &quot;FLPar&quot;
params
    a 
9e+05 
units:  NA </code></pre>
</div>
<div id="the-control-object" class="section level1">
<h1>The control object</h1>
<p>The final thing we need to set up is the control object. This tells the projection what to do, i.e. what level of fishing mortality to use.</p>
<p>A standard scenario for a short term forecast is the ‘status quo’ scenario, assuming that the future mean fishing mortality will be the same as the mean of the last X years (X depending on the stock). We will set up this scenario as a simple example using the Fbar in the last year (2008), being 0.356 per year.</p>
<pre class="r"><code>round(fbar(ple4),3)</code></pre>
<pre><code>An object of class &quot;FLQuant&quot;
, , unit = unique, season = all, area = unique

     year
age   1957  1958  1959  1960  1961 
  all 0.269 0.321 0.367 0.368 0.348

      [ ...  42 years]

     year
age   2004  2005  2006  2007  2008 
  all 0.640 0.623 0.548 0.464 0.356</code></pre>
<pre class="r"><code>ggplot(fbar(ple4), aes(x=year,y=data)) + geom_line()</code></pre>
<p><img src="Short_Term_Forecasting_for_advice_using_FLash_files/figure-html/figB-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Below, we define the last year of the stock and the status quo Fbar <code>fbar_SQ</code>.</p>
<pre class="r"><code>fbar_SQ &lt;- mean(fbar(ple4)[,as.character(maxyr_stk)])</code></pre>
<p>Now we introduce the control object: <code>fwdControl()</code>. This takes 1 argument - a data.frame that sets:</p>
<ul>
<li>The quantity (or type) of the target (we are using Fbar but can also set catch etc. - see medium term forecast tutorial)</li>
<li>The value of the target, here status quo F</li>
<li>The year the target is to be hit</li>
<li>Some other things that we will ignore for now</li>
</ul>
<p>Let’s make the data.frame</p>
<pre class="r"><code># Set the control object - year, quantity and value for the moment
ctrl_target &lt;- data.frame(year = 2009:2011, quantity = &quot;f&quot;, val = fbar_SQ)
ctrl_f &lt;- fwdControl(ctrl_target)
ctrl_f</code></pre>
<pre><code>
Target
  year quantity min    val max
1 2009        f  NA 0.3563  NA
2 2010        f  NA 0.3563  NA
3 2011        f  NA 0.3563  NA

   
    min     val     max    
  1      NA 0.35631      NA
  2      NA 0.35631      NA
  3      NA 0.35631      NA</code></pre>
<p>We see that we have what looks like our <code>ctrl_target</code>, but now it has two more columns (min and max). There is another table underneath which is for uncertainty, but that we ignore here for the short term forecast examples.</p>
</div>
<div id="running-the-stf" class="section level1">
<h1>Running the STF</h1>
<p>Below we run a simple short term forecast (STF) with ‘status quo’ future fishing mortality. Remember we had to make assumptions about the future (weights, fishing mortality pattern, discard ratio, etc.).</p>
<p>This is done using <code>fwd()</code>, which takes three objects: the stock, the control object, the SRR. It returns an updated FLStock object. This update has forecast stock numbers, based on the recruitment, fishing mortality, and natural mortality assumptions. Because we now have stock numbers, we can calculate forecast ssb.</p>
<pre class="r"><code>ple4_sq &lt;- fwd(ple4_stf, ctrl = ctrl_f, sr = ple4_sr)</code></pre>
<p>Below, we check if the recruitment in the forecast stock indeed corresponds to the mean recruitment</p>
<pre class="r"><code>mean_rec</code></pre>
<pre><code>[1] 900370</code></pre>
<pre class="r"><code>rec(ple4_sq)[,ac((maxyr_stf-5):maxyr_stf)]</code></pre>
<pre><code>An object of class &quot;FLQuant&quot;
An object of class &quot;FLQuant&quot;
, , unit = unique, season = all, area = unique

   year
age 2006   2007   2008   2009   2010   2011  
  1 820006 949341 844041 900370 900370 900370

units:  NA </code></pre>
<p>Similarly, we check if the fbar in the forecast stock indeed corresponds to status quo fishing mortality.</p>
<pre class="r"><code>round(fbar_SQ,3)</code></pre>
<pre><code>[1] 0.356</code></pre>
<pre class="r"><code>round(fbar(ple4_sq)[,ac((maxyr_stf-5):maxyr_stf)],3)</code></pre>
<pre><code>An object of class &quot;FLQuant&quot;
An object of class &quot;FLQuant&quot;
, , unit = unique, season = all, area = unique

     year
age   2006  2007  2008  2009  2010  2011 
  all 0.548 0.464 0.356 0.356 0.356 0.356

units:  f </code></pre>
<p>The stock numbers are calculated using the recruitment and future mortality assumptions.</p>
<pre class="r"><code>stock.n(ple4_sq)[,ac((maxyr_stf-5):maxyr_stf)]</code></pre>
<pre><code>An object of class &quot;FLQuant&quot;
An object of class &quot;FLQuant&quot;
, , unit = unique, season = all, area = unique

    year
age  2006     2007     2008     2009     2010     2011    
  1  820006.3 949341.2 844041.2 900369.9 900369.9 900369.9
  2  554592.5 531914.3 784234.7 634556.4 695149.1 695149.1
  3  422068.8 269655.1 267892.4 458861.8 374263.6 410001.4
  4   88052.9 212889.2 142573.0 166055.3 280909.2 229119.3
  5  136368.1  45514.9 137660.4  86954.4 107361.5 181619.3
  6   17534.5  80086.2  25575.8  94351.2  57762.5  71318.6
  7   16289.7   9240.6  49356.8  17228.2  62135.0  38039.5
  8    4114.0   9297.5   5828.1  29788.4  11325.1  40844.9
  9    2688.5   1585.1   5078.7   3558.4  17078.0   6492.8
  10   2854.5   3660.1   6750.3   9212.2   8330.8  16575.1

units:  NA </code></pre>
<p>Note that the future harvest slot is different from the harvest from the one we set up, but that the selection pattern is the same: F at age has been multiplied by a constant value to give us the target Fbar value.</p>
<pre class="r"><code>round(harvest(ple4_stf)[,ac((maxyr_stf-2):maxyr_stf)],3)</code></pre>
<pre><code>An object of class &quot;FLQuant&quot;
An object of class &quot;FLQuant&quot;
, , unit = unique, season = all, area = unique

    year
age  2009  2010  2011 
  1  0.203 0.203 0.203
  2  0.548 0.548 0.548
  3  0.500 0.500 0.500
  4  0.430 0.430 0.430
  5  0.395 0.395 0.395
  6  0.407 0.407 0.407
  7  0.409 0.409 0.409
  8  0.584 0.584 0.584
  9  0.419 0.419 0.419
  10 0.419 0.419 0.419

units:  f </code></pre>
<pre class="r"><code>round(harvest(ple4_sq)[,ac((maxyr_stf-2):maxyr_stf)],3)</code></pre>
<pre><code>An object of class &quot;FLQuant&quot;
An object of class &quot;FLQuant&quot;
, , unit = unique, season = all, area = unique

    year
age  2009  2010  2011 
  1  0.159 0.159 0.159
  2  0.428 0.428 0.428
  3  0.391 0.391 0.391
  4  0.336 0.336 0.336
  5  0.309 0.309 0.309
  6  0.318 0.318 0.318
  7  0.320 0.320 0.320
  8  0.456 0.456 0.456
  9  0.327 0.327 0.327
  10 0.327 0.327 0.327

units:  f </code></pre>
<pre class="r"><code>harvest(ple4_stf)[,ac((maxyr_stf-2):maxyr_stf)] / harvest(ple4_sq)[,ac((maxyr_stf-2):maxyr_stf)]</code></pre>
<pre><code>An object of class &quot;FLQuant&quot;
An object of class &quot;FLQuant&quot;
, , unit = unique, season = all, area = unique

    year
age  2009   2010   2011  
  1  1.2797 1.2797 1.2797
  2  1.2797 1.2797 1.2797
  3  1.2797 1.2797 1.2797
  4  1.2797 1.2797 1.2797
  5  1.2797 1.2797 1.2797
  6  1.2797 1.2797 1.2797
  7  1.2797 1.2797 1.2797
  8  1.2797 1.2797 1.2797
  9  1.2797 1.2797 1.2797
  10 1.2797 1.2797 1.2797

units:  NA </code></pre>
<p>The catch numbers come from the predicted abundance and harvest rates using the Baranov equation. The catches are then split into landings and discards using the average ratios computed by <code>stf()</code>.</p>
<pre class="r"><code>landings.n(ple4_sq)[,ac((maxyr_stf-5):maxyr_stf)]</code></pre>
<pre><code>An object of class &quot;FLQuant&quot;
An object of class &quot;FLQuant&quot;
, , unit = unique, season = all, area = unique

    year
age  2006     2007     2008     2009     2010     2011    
  1    355.00  1286.00   380.00   871.47   871.47   871.47
  2  18987.00 19205.00 10970.00 14418.91 15795.74 15795.74
  3  67465.00 37309.00 42865.00 59684.58 48680.81 53329.26
  4  25254.00 47053.00 37970.00 35832.72 60616.80 49441.17
  5  42525.00 14971.00 29476.00 20398.74 25186.06 42606.28
  6   6555.00 17142.00  5700.00 20939.33 12819.21 15827.72
  7   4967.00  2459.00  6752.00  3332.27 12018.13  7357.58
  8   2053.00  1856.00   912.00  6773.26  2575.09  9287.29
  9   1235.00   543.00   673.00   947.53  4547.50  1728.89
  10  1319.00  1259.00   896.00  2453.01  2218.31  4413.60

units:  NA </code></pre>
<pre class="r"><code>discards.n(ple4_sq)[,ac((maxyr_stf-5):maxyr_stf)]</code></pre>
<pre><code>An object of class &quot;FLQuant&quot;
An object of class &quot;FLQuant&quot;
, , unit = unique, season = all, area = unique

    year
age  2006     2007     2008     2009     2010     2011    
  1  220473.0  77312.0 135406.0 125015.3 125015.3 125015.3
  2  225077.0 205140.0 252629.0 196572.8 215343.2 215343.2
  3  110215.0  69312.0  37393.0  82004.2  66885.5  73272.3
  4   10656.0  10735.0   6237.0   9402.9  15906.5  12973.9
  5    3000.0   1437.0   2282.0   1656.6   2045.4   3460.1
  6     410.0   7151.0    517.0   3564.4   2182.1   2694.3
  7     754.0    204.0   8882.0   1163.8   4197.2   2569.5
  8     194.0   1649.0    891.0   3652.4   1388.6   5008.1
  9       0.0      0.0      0.0      0.0      0.0      0.0
  10      0.0      0.0      0.0      0.0      0.0      0.0

units:  NA </code></pre>
<p>We can see the projection using a plot here</p>
<pre class="r"><code>plot(ple4_sq) + geom_vline(lty=2,xintercept=an(ISOdate(maxyr_stk+1,1,1)))</code></pre>
<p><img src="Short_Term_Forecasting_for_advice_using_FLash_files/figure-html/unnamed-chunk-17-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="short-term-forecast-with-many-f-scenarios" class="section level1">
<h1>Short term forecast with many F scenarios</h1>
<p>Typically when running STF you explore several different future F scenarios. The scenarios are based on ‘F status quo’, which we calculated above as the mean F of the last X years.</p>
<p>For a 3 year STF the F pattern is:</p>
<ul>
<li>year 1: fbar_status_quo</li>
<li>year 2: fbar_status_quo * fbar_multiplier</li>
<li>year 3: fbar_status_quo * fbar_multiplier</li>
</ul>
<p>Note that year 1 is typically called the ‘intermediate year’ (in ICES, this would be the year the Expert Group meets to run the assessment, and status quo F for the intermediate year is a common assumption), and the fbar_multiplier is the same for years 2 and 3</p>
<p>We are going to run several STFs with different values for the fbar_multiplier</p>
<pre class="r"><code>fbar_multiplier &lt;- seq(from = 0, to = 2, by = 0.2)</code></pre>
<p>Next we are going to build a data.frame that creates these scenarios. Each column in the dataframe is a year, each row is a scenario. Note that if you project for more than 3 years you will need to add more columns / years to the matrix</p>
<pre class="r"><code>fbar_scenarios &lt;- cbind(rep(fbar_SQ,length(fbar_multiplier)),
                        fbar_multiplier*fbar_SQ,
                        fbar_multiplier*fbar_SQ)</code></pre>
<p>Another scenario we are interested in is <span class="math inline">\(F_{0.1}\)</span>. We can calculate this using <a href="http://doc.flr-project.org/Reference_points_for_fisheries_management_with_FLBRP.html">FLBRP</a> (or maybe you already have a value).</p>
<pre class="r"><code>f01 &lt;- c(refpts(brp(FLBRP(ple4)))[&quot;f0.1&quot;,&quot;harvest&quot;])
# Add the F0.1 scenario as a final scenario 
fbar_scenarios &lt;- rbind(fbar_scenarios, c(fbar_SQ,f01,f01))</code></pre>
<pre class="r"><code># Add some names
colnames(fbar_scenarios) &lt;- c(&quot;2009&quot;,&quot;2010&quot;,&quot;2011&quot;)
rownames(fbar_scenarios) &lt;- c(fbar_multiplier, &quot;f01&quot;)
fbar_scenarios</code></pre>
<table>
<thead>
<tr class="header">
<th></th>
<th align="right">2009</th>
<th align="right">2010</th>
<th align="right">2011</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td align="right">0.3563</td>
<td align="right">0.0000</td>
<td align="right">0.0000</td>
</tr>
<tr class="even">
<td>0.2</td>
<td align="right">0.3563</td>
<td align="right">0.0713</td>
<td align="right">0.0713</td>
</tr>
<tr class="odd">
<td>0.4</td>
<td align="right">0.3563</td>
<td align="right">0.1425</td>
<td align="right">0.1425</td>
</tr>
<tr class="even">
<td>0.6</td>
<td align="right">0.3563</td>
<td align="right">0.2138</td>
<td align="right">0.2138</td>
</tr>
<tr class="odd">
<td>0.8</td>
<td align="right">0.3563</td>
<td align="right">0.2850</td>
<td align="right">0.2850</td>
</tr>
<tr class="even">
<td>1</td>
<td align="right">0.3563</td>
<td align="right">0.3563</td>
<td align="right">0.3563</td>
</tr>
<tr class="odd">
<td>1.2</td>
<td align="right">0.3563</td>
<td align="right">0.4276</td>
<td align="right">0.4276</td>
</tr>
<tr class="even">
<td>1.4</td>
<td align="right">0.3563</td>
<td align="right">0.4988</td>
<td align="right">0.4988</td>
</tr>
<tr class="odd">
<td>1.6</td>
<td align="right">0.3563</td>
<td align="right">0.5701</td>
<td align="right">0.5701</td>
</tr>
<tr class="even">
<td>1.8</td>
<td align="right">0.3563</td>
<td align="right">0.6414</td>
<td align="right">0.6414</td>
</tr>
<tr class="odd">
<td>2</td>
<td align="right">0.3563</td>
<td align="right">0.7126</td>
<td align="right">0.7126</td>
</tr>
<tr class="even">
<td>f01</td>
<td align="right">0.3563</td>
<td align="right">0.0876</td>
<td align="right">0.0876</td>
</tr>
</tbody>
</table>
<p>There are various results we want to extract from the STF, like predicted Catch, SSB and the relative change in these. First, make an empty matrix in which to store the results.</p>
<pre class="r"><code>stf_results &lt;- matrix(NA,nrow = nrow(fbar_scenarios),ncol = 8)
# Set some column names
colnames(stf_results) &lt;- c(&#39;Fbar&#39;,
    paste0(&#39;Catch&#39;,maxyr_stk+1), 
    paste0(&#39;Catch&#39;,maxyr_stk+2),
    paste0(&#39;Catch&#39;,maxyr_stk+3),
    paste0(&#39;SSB&#39;,maxyr_stk+2),
    paste0(&#39;SSB&#39;,maxyr_stk+3),
    paste0(&#39;SSB_change_&#39;,maxyr_stk+2,&#39;-&#39;,maxyr_stk+3,&#39;(%)&#39;),
    paste0(&#39;Catch_change_&#39;,maxyr_stk,&#39;-&#39;,maxyr_stk+2,&#39;(%)&#39;))</code></pre>
<pre class="r"><code># Set up an FLStocks object to store the resulting FLStock each time
stk_stf &lt;- FLStocks()
# Loop over the scenarios (each row in the fbar_scenarios table)
for (scenario in 1:nrow(fbar_scenarios)) {
    cat(&quot;Scenario: &quot;, scenario, &quot;\n&quot;)
    flush.console()
    # Make a target object with F values for that scenario
    # Set the control object - year, quantity and value for the moment
    ctrl_target &lt;- data.frame(year = (maxyr_stf-2):maxyr_stf,
                              quantity = &quot;f&quot;,
                              val = fbar_scenarios[scenario,])
    # ctrl_target
    ctrl_f &lt;- fwdControl(ctrl_target)
    # Run the forward projection. We could include an additional argument, maxF.
    # By default the value of maxF is 2.0. It could be increased to 10.0, say,
    # so that F is less limited, and the bound is not hit (not a problem here).
    ple4_fwd &lt;- fwd(ple4_stf, ctrl = ctrl_f, sr = ple4_sr)#, maxF = 10.0)
    ## Check it has worked - uncomment out to check scenario by scenario
    # plot(ple4_fwd[,ac(2001:2011)])
    # Store the result - if you want to, comment out if unnecessary
    stk_stf[[as.character(scenario)]] &lt;- ple4_fwd

    # Fill results table
    stf_results[scenario,1] &lt;- round(fbar(ple4_fwd)[,ac(2011)],3) # final stf year
    stf_results[scenario,2] &lt;- catch(ple4_fwd)[,ac(maxyr_stk+1)] # 1st stf year
    stf_results[scenario,3] &lt;- catch(ple4_fwd)[,ac(maxyr_stk+2)] # 2nd stf year
    stf_results[scenario,4] &lt;- catch(ple4_fwd)[,ac(maxyr_stk+3)] # final stf year
    stf_results[scenario,5] &lt;- ssb(ple4_fwd)[,ac(maxyr_stk+2)] # 2nd stf year
    stf_results[scenario,6] &lt;- ssb(ple4_fwd)[,ac(maxyr_stk+3)] # final stf year
    
    # change in ssb in last two stf years
    stf_results[scenario,7] &lt;- round((ssb(ple4_fwd)[,ac(maxyr_stk+3)]-ssb(ple4_fwd)[,ac(maxyr_stk+2)])/
                                      ssb(ple4_fwd)[,ac(maxyr_stk+2)]*100,1) 
    
    # change in catch from true year, to 2nd to last stf year
    stf_results[scenario,8] &lt;- round((catch(ple4_fwd)[,ac(maxyr_stk+2)]-catch(ple4_fwd)[,ac(maxyr_stk)])/
                                      catch(ple4_fwd)[,ac(maxyr_stk)]*100,1) 
}
# Give the FLStocks object some names
names(stk_stf) &lt;- rownames(fbar_scenarios)

# Plotting
plot(stk_stf)</code></pre>
<p><img src="Short_Term_Forecasting_for_advice_using_FLash_files/figure-html/unnamed-chunk-23-1.png" width="672" style="display: block; margin: auto;" /> The different scenarios are plotted above. The table of results is given below.</p>
<pre class="r"><code>stf_results</code></pre>
<table>
<thead>
<tr class="header">
<th align="right">Fbar</th>
<th align="right">Catch2009</th>
<th align="right">Catch2010</th>
<th align="right">Catch2011</th>
<th align="right">SSB2010</th>
<th align="right">SSB2011</th>
<th align="right">SSB_change_2010-2011(%)</th>
<th align="right">Catch_change_2008-2010(%)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">0.000</td>
<td align="right">106368</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">268307</td>
<td align="right">410158</td>
<td align="right">52.9</td>
<td align="right">-100.0</td>
</tr>
<tr class="even">
<td align="right">0.071</td>
<td align="right">106368</td>
<td align="right">26377</td>
<td align="right">36153</td>
<td align="right">268307</td>
<td align="right">383213</td>
<td align="right">42.8</td>
<td align="right">-72.5</td>
</tr>
<tr class="odd">
<td align="right">0.143</td>
<td align="right">106368</td>
<td align="right">50963</td>
<td align="right">65598</td>
<td align="right">268307</td>
<td align="right">358124</td>
<td align="right">33.5</td>
<td align="right">-46.9</td>
</tr>
<tr class="even">
<td align="right">0.214</td>
<td align="right">106368</td>
<td align="right">73885</td>
<td align="right">89367</td>
<td align="right">268307</td>
<td align="right">334758</td>
<td align="right">24.8</td>
<td align="right">-23.1</td>
</tr>
<tr class="odd">
<td align="right">0.285</td>
<td align="right">106368</td>
<td align="right">95259</td>
<td align="right">108345</td>
<td align="right">268307</td>
<td align="right">312995</td>
<td align="right">16.7</td>
<td align="right">-0.8</td>
</tr>
<tr class="even">
<td align="right">0.356</td>
<td align="right">106368</td>
<td align="right">115195</td>
<td align="right">123285</td>
<td align="right">268307</td>
<td align="right">292719</td>
<td align="right">9.1</td>
<td align="right">19.9</td>
</tr>
<tr class="odd">
<td align="right">0.428</td>
<td align="right">106368</td>
<td align="right">133794</td>
<td align="right">134831</td>
<td align="right">268307</td>
<td align="right">273827</td>
<td align="right">2.1</td>
<td align="right">39.3</td>
</tr>
<tr class="even">
<td align="right">0.499</td>
<td align="right">106368</td>
<td align="right">151151</td>
<td align="right">143535</td>
<td align="right">268307</td>
<td align="right">256221</td>
<td align="right">-4.5</td>
<td align="right">57.4</td>
</tr>
<tr class="odd">
<td align="right">0.570</td>
<td align="right">106368</td>
<td align="right">167352</td>
<td align="right">149864</td>
<td align="right">268307</td>
<td align="right">239810</td>
<td align="right">-10.6</td>
<td align="right">74.3</td>
</tr>
<tr class="even">
<td align="right">0.641</td>
<td align="right">106368</td>
<td align="right">182478</td>
<td align="right">154218</td>
<td align="right">268307</td>
<td align="right">224511</td>
<td align="right">-16.3</td>
<td align="right">90.0</td>
</tr>
<tr class="odd">
<td align="right">0.713</td>
<td align="right">106368</td>
<td align="right">196604</td>
<td align="right">156937</td>
<td align="right">268307</td>
<td align="right">210245</td>
<td align="right">-21.6</td>
<td align="right">104.7</td>
</tr>
<tr class="even">
<td align="right">0.088</td>
<td align="right">106368</td>
<td align="right">32168</td>
<td align="right">43457</td>
<td align="right">268307</td>
<td align="right">377302</td>
<td align="right">40.6</td>
<td align="right">-66.5</td>
</tr>
</tbody>
</table>
</div>
<div id="more-information" class="section level1">
<h1>More information</h1>
<ul>
<li>You can submit bug reports, questions or suggestions on this tutorial at <a href="https://github.com/flr/doc/issues" class="uri">https://github.com/flr/doc/issues</a>.</li>
<li>Or send a pull request to <a href="https://github.com/flr/doc/" class="uri">https://github.com/flr/doc/</a></li>
<li>For more information on the FLR Project for Quantitative Fisheries Science in R, visit the FLR webpage, <a href="http://flr-project.org" class="uri">http://flr-project.org</a>.</li>
</ul>
<div id="software-versions" class="section level2">
<h2>Software Versions</h2>
<ul>
<li>R version 3.4.1 (2017-06-30)</li>
<li>FLCore: 2.6.5</li>
<li>FLAssess: 2.6.1</li>
<li>FLash: 2.5.8</li>
<li>ggplotFL: 2.6.1</li>
<li>ggplot2: 2.2.1</li>
<li>FLBRP: 2.5.2</li>
<li><strong>Compiled</strong>: Wed Sep 13 16:33:31 2017</li>
</ul>
</div>
<div id="license" class="section level2">
<h2>License</h2>
<p>This document is licensed under the <a href="https://creativecommons.org/licenses/by-sa/4.0">Creative Commons Attribution-ShareAlike 4.0 International</a> license.</p>
</div>
<div id="author-information" class="section level2">
<h2>Author information</h2>
<p><strong>Jan-Jaap Poos</strong> Wageningen UR. Wageningen Marine Research. Haringkade 1, IJmuiden, The Netherlands.</p>
<p><strong>Katell Hamon</strong> Wageningen UR. Wageningen Economic Research. Alexanderveld 5, The Hague, The Netherlands.</p>
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
